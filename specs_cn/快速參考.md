# Log Detect Backend - 快速參考指南

## 專案概述

**名稱**: Log Detect Backend
**目的**: 集中式日誌監控、設備健康追蹤和異常檢測系統
**語言**: Go 1.24.0
**框架**: Gin Web Framework
**資料庫**: MySQL, TimescaleDB, Elasticsearch
**端口**: 8006

---

## 主要功能一覽

| 功能 | 目的 | 關鍵檔案 |
|---------|---------|-----------|
| **設備監控** | 檢測線上/離線狀態 | detect.go, center.go |
| **Elasticsearch 健康監控** | 監控 ES 叢集健康狀態 | es_monitor_service.go, es_scheduler.go |
| **電子郵件警報** | 發送通知 | mail.go, detect.go |
| **使用者管理** | 身份驗證與權限控制 | auth.go, middleware/auth.go |
| **時間序列資料** | 高效儲存指標 | batch_writer.go (TimescaleDB) |
| **儀表板** | 視覺化與分析 | dashboard.go, controller/dashboard.go |
| **REST API** | HTTP 介面 | router/router.go, controller/* |
| **定時任務** | 排程監控 | center.go, services/detect.go |

---

## 核心資料模型

### 監控實體
```
Target (監控設定)
  ├─ Indices (多對多關係)
  │   ├─ Pattern: ES 索引模式
  │   ├─ Logname: 日誌類型名稱
  │   ├─ Period: 分鐘/小時
  │   └─ Unit: 頻率數值
  └─ Receivers (電子郵件清單)

Device (設備)
  ├─ DeviceGroup: 邏輯分組
  └─ Name: 設備主機名稱

History (監控結果)
  ├─ Status: 線上/離線/警告/錯誤
  ├─ Lost: true/false
  ├─ DateTime: 檢查時間
  ├─ ResponseTime: 毫秒
  └─ DataCount: 找到的記錄數
```

### 身份驗證實體
```
User (使用者)
  └─ Role (一對一關係)
      └─ Permissions (多對多關係)
          ├─ Resource: device, target, indices, elasticsearch
          └─ Action: create, read, update, delete
```

### Elasticsearch 監控
```
ElasticsearchMonitor (設定)
  ├─ Host/Port/Auth
  ├─ CheckInterval: 秒數
  ├─ Thresholds: CPU/記憶體/磁碟/回應時間
  └─ Receivers: 電子郵件警報

ESMetric (測量值)
  ├─ Time: 時間戳記
  ├─ CPU/Memory/Disk: 百分比
  ├─ NodeCount: 活動節點數
  └─ UnassignedShards: 分片狀態

ESAlert (警告)
  ├─ Severity: 嚴重/高/中/低
  ├─ Status: 活動/已解決/已確認
  └─ Message: 警報詳情
```

---

## 重要檔案位置

### 設定檔
```
config.yml              # 主要設定
setting.yml            # 監控目標設定
```

### 原始碼目錄
```
controller/            # HTTP 處理器 (9 個檔案)
services/              # 業務邏輯 (22 個服務)
entities/              # 資料模型 (targets.go, elasticsearch.go, menu.go)
models/                # 回應結構
middleware/            # 身份驗證與權限控制
clients/               # 資料庫連線
router/                # 路由定義
```

### 資料庫結構
```
MySQL (logdetect 資料庫)
  ├─ users, roles, permissions (權限控制)
  ├─ devices, targets, indices (設定)
  ├─ history, alert_history, mail_history (日誌)
  └─ cron_lists, elasticsearch_monitors (管理)

TimescaleDB (monitoring 資料庫)
  ├─ device_metrics (時間序列)
  ├─ es_metrics (時間序列)
  └─ alert_history (警報)
```

---

## API 端點快速清單

### 身份驗證
```
POST   /auth/login
POST   /api/v1/auth/register
GET    /api/v1/auth/profile
POST   /api/v1/auth/refresh
```

### 設備管理
```
GET    /api/v1/Device/GetAll
POST   /api/v1/Device/Create
PUT    /api/v1/Device/Update
DELETE /api/v1/Device/Delete/:id
GET    /api/v1/Device/GetGroup
GET    /api/v1/Device/count
```

### 目標管理 (監控設定)
```
GET    /api/v1/Target/GetAll
POST   /api/v1/Target/Create
PUT    /api/v1/Target/Update
DELETE /api/v1/Target/Delete/:id
```

### Elasticsearch 監控
```
GET    /api/v1/elasticsearch/monitors
POST   /api/v1/elasticsearch/monitors
GET    /api/v1/elasticsearch/status
GET    /api/v1/elasticsearch/alerts
POST   /api/v1/elasticsearch/monitors/:id/test
```

### 儀表板與分析
```
GET    /api/v1/dashboard/overview
GET    /api/v1/dashboard/statistics
GET    /api/v1/dashboard/trends
GET    /api/v1/dashboard/devices/:device_name/timeline
```

### 歷史記錄與監控
```
GET    /api/v1/History/GetData/:logname
GET    /api/v1/History/GetLognameData
```

---

## 工作流程範例

### 設備監控運作方式

1. **設定**
   - 管理員建立 Target (電子郵件收件人)
   - 管理員建立 Index (ES 模式 + 日誌名稱)
   - 管理員將 Index 連結到 Target

2. **排程**
   - Control_center() 讀取所有已啟用的 Targets
   - 為每個 Index 建立 cron job 表達式
   - 使用 robfig/cron 排程器註冊
   - 範例: "*/5 * * * *" = 每 5 分鐘

3. **執行**
   - Cron 觸發 Detect() 函式
   - 查詢 Elasticsearch 以取得時間範圍內的設備
   - 與 Device 資料庫比較
   - 為每個設備建立 History 記錄
   - 為離線設備發送電子郵件
   - 將指標儲存到 TimescaleDB (透過 BatchWriter)

### ES 監控運作方式

1. **設定**
   - 管理員建立 ElasticsearchMonitor
   - 設定檢查間隔 (例如: 60 秒)
   - 設定警報閾值

2. **排程**
   - ESMonitorScheduler 載入所有已啟用的監控器
   - 為每個監控器建立計時器
   - 啟動背景 goroutine

3. **健康檢查**
   - 定期查詢 ES 叢集健康狀態
   - 收集 CPU、記憶體、磁碟、分片資料
   - 與閾值比較
   - 如果超過閾值則建立 ESAlert
   - 發送電子郵件通知
   - 將指標儲存到 TimescaleDB

### 批次寫入運作方式

1. **累積**
   - 服務生成 History 或 ESMetric 記錄
   - BatchWriter.AddHistory() 將它們加入佇列
   - 保存在記憶體中

2. **觸發刷新**
   - 大小: >= 50 筆記錄
   - 時間: 經過 5 秒 (可設定)

3. **批次插入**
   - 開始交易
   - 使用預備語句插入所有記錄
   - 提交 (原子性，全有或全無)
   - 記錄成功數量

---

## 關鍵服務及其職責

| 服務 | 主要函式 | 關鍵邏輯 |
|---------|---|---|
| **auth.go** | HashPassword, GenerateJWT, ValidateJWT, CheckPermission | 權限控制執行、令牌管理 |
| **detect.go** | Detect, SearchRequest, GetDevicesDataByGroupName | 核心監控: ES 查詢、設備比較、警報 |
| **center.go** | ExecuteCrontab, Control_center | Cron job 註冊與啟動 |
| **batch_writer.go** | AddHistory, flushDeviceMetrics, flushESMetrics | 時間序列資料批次處理與插入 |
| **es_monitor_service.go** | CreateESMonitor, UpdateESMonitor, GetAllESMonitors | ES 監控器 CRUD 操作 |
| **es_scheduler.go** | InitESScheduler, StartMonitor, LoadAllMonitors | ES 健康檢查排程 |
| **mail.go** | Mail4 | SMTP 電子郵件發送，包含 HTML 範本 |
| **history.go** | CreateHistory, GetHistoryDataByDeviceName | 歷史資料管理 |
| **device.go** | CreateDevice, UpdateDevice, GetDevicesDataByGroupName | 設備 CRUD 與分組 |
| **target.go** | CreateTarget, UpdateTarget, GetAllTargets | 目標 CRUD 與協調 |
| **indices.go** | CreateIndices, UpdateIndices, GetIndicesDataByLogname | 索引模式 CRUD |
| **dashboard.go** | GetDashboardData, GetHistoryStatistics, GetTrendData | 分析與視覺化 |

---

## 常見操作

### 開始監控新的日誌來源

```go
// 1. 建立 Index (ES 模式定義)
Index{
  Pattern: "logstash-prod-*",
  Logname: "webserver",
  Period: "minutes",
  Unit: 5,           // 每 5 分鐘檢查一次
  Field: "host.keyword"
}

// 2. 建立 Target (收件人設定)
Target{
  Subject: "Web Server Monitoring",
  To: ["admin@company.com"],
  Enable: true,
  Indices: [...]  // 連結索引
}

// 3. 系統自動:
// - 註冊 cron job "*/5 * * * *"
// - 開始執行 detect()
// - 將結果儲存到 History
// - 為離線設備發送警報
```

### 建立 Elasticsearch 健康監控器

```go
ElasticsearchMonitor{
  Name: "Production ES Cluster",
  Host: "10.99.1.213",
  Port: 9200,
  Interval: 60,        // 每 60 秒檢查一次
  CPUUsageHigh: 75.0,
  CPUUsageCritical: 85.0,
  MemoryUsageHigh: 80.0,
  MemoryUsageCritical: 90.0,
  DiskUsageHigh: 85.0,
  DiskUsageCritical: 95.0,
  Receivers: ["ops@company.com"],
  Subject: "ES Health Alert"
}

// 系統自動:
// - 在 MySQL 中建立設定
// - 啟動監控排程器
// - 收集指標到 TimescaleDB
// - 在超過閾值時發送警報
```

### 查詢設備歷史記錄

```
GET /api/v1/History/GetData/webserver?days=7

回傳:
[
  {
    date: "2024-10-29",
    logname: "webserver",
    name: "web-server-01",
    status: "online",
    time: "14:30:00",
    response_time: 245,
    data_count: 1523
  },
  ...
]
```

---

## 資料庫連線詳情

### MySQL (GORM)
```
Host: 10.99.1.133
Port: 3306
Database: logdetect
User: runner
Password: (從 config.yml 取得)
Pool: Max Idle=10, Max Open=100
Lifetime: 1 小時
```

### TimescaleDB (PostgreSQL)
```
Host: 10.99.1.213
Port: 5432
Database: monitoring
User: logdetect
Password: (從 config.yml 取得)
Pool: Max Idle=10, Max Open=100
Timezone: Asia/Taipei
```

### Elasticsearch
```
URL: https://10.99.1.213:9200
Username: elastic
Password: (從 config.yml 取得)
SSL: InsecureSkipVerify=true (僅限開發環境!)
Indices: logstash-*, 自訂模式
```

---

## JWT 令牌詳情

- **演算法**: HS256 (HMAC-SHA256)
- **有效期**: 24 小時
- **密鑰**: 從 JWT_SECRET 環境變數取得
- **聲明**: user_id, username, role_id, exp, iat
- **格式**: 在 Authorization 標頭中使用 Bearer {token}

---

## 權限模型

```
資源: device, target, receiver, indices, elasticsearch, user
動作: create, read, update, delete

範例:
- Permission: "device.create" (建立設備)
- Permission: "target.update" (更新目標)
- Permission: "elasticsearch.read" (檢視 ES 監控器)

預設角色:
- admin: 所有權限
- user: 唯讀存取
- operator: 指定資源的 CRUD 權限
```

---

## 啟動順序

1. 載入環境設定 (config.yml)
2. 初始化 MySQL 連線 (GORM)
3. 初始化 TimescaleDB 連線 (SQL)
4. 建立資料庫結構 (AutoMigrate)
5. 初始化 BatchWriter (用於時間序列資料)
6. 初始化 Elasticsearch 客戶端
7. 建立預設的權限控制角色與權限
8. 載入 cron 排程器
9. 初始化 ES 監控排程器
10. 啟動所有監控目標
11. 在端口 8006 上啟動 HTTP 伺服器
12. 準備接受請求

---

## 除錯技巧

### 啟用除錯日誌
```go
// 在 main.go 中
log.Logrecord_no_rotate("DEBUG", "message here")
```

### 檢查執行中的 Cron Jobs
```sql
-- 檢視已註冊的 cron jobs
SELECT * FROM cron_lists;

-- 檢視監控歷史記錄
SELECT * FROM history ORDER BY created_at DESC LIMIT 10;

-- 檢視 ES 監控資料
SELECT * FROM elasticsearch_monitors;
```

### 常見問題

**問題**: 設備未被檢測到
- 檢查 Elasticsearch 連線
- 驗證索引模式是否匹配
- 檢查 detect.go 中的時間範圍計算
- 檢視 CloudWatch/日誌以查看 ES 查詢錯誤

**問題**: 電子郵件未發送
- 驗證 config.yml 中的 SMTP 憑證
- 檢查電子郵件服務日誌
- 驗證收件人電子郵件地址

**問題**: Cron jobs 未執行
- 檢查 global.Crontab 是否已初始化
- 驗證目標是否已啟用
- 檢查 cron_lists 表以查看已註冊的工作

**問題**: 效能下降
- 監控 batch_writer 刷新時間
- 檢查 TimescaleDB 插入效能
- 檢視 ES 查詢效能
- 檢查資料庫連線池使用率

---

## 檔案統計

| 類別 | 數量 | 範例 |
|----------|-------|----------|
| 控制器 | 9 | auth.go, device.go, target.go, ... |
| 服務 | 22 | detect.go, center.go, batch_writer.go, ... |
| 實體 | 20+ | User, Role, Device, Target, Index, History, ... |
| API 路由 | 60+ | 所有 CRUD 操作 + 儀表板 + ES 監控 |
| 資料庫表格 | 16+ | users, targets, history, elasticsearch_monitors, ... |
| 設定區段 | 8 | database, timescale, es, email, server, cors, sso |

---

## 重要目錄

| 路徑 | 目的 |
|------|---------|
| `/controller` | HTTP 請求處理器 |
| `/services` | 業務邏輯與操作 |
| `/entities` | 資料模型定義 |
| `/clients` | 資料庫與外部服務連線 |
| `/middleware` | 身份驗證與授權 |
| `/router` | 路由定義與設定 |
| `/models` | 回應與資料結構 |
| `/global` | 全域應用程式狀態 |
| `/structs` | 設定結構 |
| `/log_record` | 日誌檔案儲存位置 |
| `/specs` | 文件 (包含此檔案) |
| `/docs` | Swagger API 文件 |

---

## 技術版本

```
Go: 1.24.0
Gin: v1.9.1
GORM: v1.25.7
Elasticsearch: v8
PostgreSQL/TimescaleDB: 12+
MySQL: 5.7+
JWT: github.com/golang-jwt/jwt/v5
Cron: github.com/robfig/cron/v3
```

---

## 外部相依套件

- **Gin-gonic**: 具有中介軟體的 Web 框架
- **GORM**: MySQL 的 ORM
- **lib/pq**: TimescaleDB 的 PostgreSQL 驅動程式
- **golang-jwt**: JWT 令牌處理
- **bcrypt**: 密碼雜湊
- **robfig/cron**: 工作排程
- **elastic/go-elasticsearch**: ES 客戶端
- **swaggo**: Swagger 文件
- **natefinch/lumberjack**: 日誌檔案輪替

---

本快速參考涵蓋了理解和使用 Log Detect Backend 系統所需的基本資訊。
