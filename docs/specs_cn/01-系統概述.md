# Log Detect Backend - 系統概述

## 文件資訊

| 項目   | 內容                  |
| ---- | ------------------- |
| 文件版本 | 2.0                 |
| 最後更新 | 2025-11-18          |
| 文件類型 | 軟體設計文件 (SDD) - 系統概述 |
| 專案名稱 | Log Detect Backend  |
| 專案版本 | 1.0                 |

---

## 1. 專案簡介

### 1.1 系統目的

Log Detect Backend 是一個基於 Go 語言開發的全方位日誌監控與異常檢測系統，旨在提供：

1. **即時裝置監控**：透過 Elasticsearch 查詢裝置狀態，自動偵測裝置上線/離線變化
2. **Elasticsearch 健康監控**：持續監控 ES 叢集健康狀態、效能指標與容量使用
3. **智慧警報系統**：基於閾值的自動警報生成與電子郵件通知
4. **時序資料分析**：使用 TimescaleDB 儲存並分析歷史監控資料
5. **視覺化儀表板**：提供豐富的統計圖表與趨勢分析
6. **細緻權限控制**：基於 RBAC 的使用者與角色權限管理

### 1.2 系統範圍

**包含功能：**

- 裝置監控與自動發現
- Elasticsearch 叢集監控
- 警報管理與通知
- 使用者認證與授權（JWT + RBAC）
- 監控資料的批次寫入與儲存
- 歷史資料查詢與分析
- RESTful API 服務
- Swagger API 文件

**不包含功能：**

- 前端使用者介面（獨立專案）
- 日誌收集功能（由 Logstash 等工具負責）
- 資料庫管理與備份（由 DBA 負責）

### 1.3 目標使用者

| 使用者類型   | 主要用途              | 權限等級    |
| ------- | ----------------- | ------- |
| 系統管理員   | 完整系統配置、使用者管理、監控設定 | 完整權限    |
| 維運人員    | 監控設定、警報管理、資料查詢    | CRUD 權限 |
| 一般使用者   | 查看監控資料、檢視警報       | 唯讀權限    |
| API 整合者 | 透過 API 整合第三方系統    | 依配置權限   |

---

## 2. 系統特色

### 2.1 核心特性

#### 2.1.1 多維度監控

- **裝置層級監控**：自動發現裝置、追蹤裝置狀態變化
- **叢集層級監控**：Elasticsearch 健康狀態、效能指標
- **業務層級監控**：基於日誌模式的自定義監控

#### 2.1.2 彈性排程系統

- **動態 Cron 作業**：支援分鐘級至小時級的監控頻率
- **獨立 ES 監控排程器**：可配置的健康檢查間隔（10-3600 秒）
- **作業生命週期管理**：自動註冊、更新、停止監控作業

#### 2.1.3 高效資料處理

- **批次寫入機制**：記憶體累積 + 定期刷新（預設 50 筆或 5 秒）
- **時序資料最佳化**：使用 TimescaleDB 超表自動分區
- **多資料庫架構**：MySQL（配置） + TimescaleDB（指標） + Elasticsearch（日誌）

#### 2.1.4 完整權限管理

- **JWT 身份驗證**：HS256 簽署、24 小時過期
- **RBAC 授權模型**：User → Role → Permissions
- **資源級權限控制**：細緻到 resource.action 層級
- **中介軟體鏈驗證**：AuthMiddleware → PermissionMiddleware

### 2.2 技術亮點

#### 2.2.1 技術堆疊

| 層級     | 技術            | 版本     | 用途         |
| ------ | ------------- | ------ | ---------- |
| 程式語言   | Go            | 1.24   | 主要開發語言     |
| Web 框架 | Gin           | 1.9.1  | HTTP 服務與路由 |
| ORM    | GORM          | latest | 資料庫操作抽象    |
| 配置資料庫  | MySQL         | 8.0    | 系統配置與元資料   |
| 時序資料庫  | TimescaleDB   | latest | 監控指標儲存     |
| 搜尋引擎   | Elasticsearch | v8     | 日誌儲存與查詢    |
| 排程器    | robfig/cron   | v3     | 定時任務管理     |
| 身份驗證   | golang-jwt    | v5     | JWT 令牌處理   |
| 密碼加密   | bcrypt        | latest | 密碼雜湊       |
| API 文件 | Swagger       | latest | API 規格文件   |

#### 2.2.2 設計模式

- **單例模式**：全域資料庫連線、ES 監控排程器
- **工廠模式**：服務物件建立
- **中介軟體鏈**：請求處理管線
- **批次處理模式**：資料寫入最佳化
- **觀察者模式**：監控與警報系統

---

## 3. 系統架構概覽

### 3.1 整體架構

```
┌─────────────────────────────────────────────────────┐
│                   客戶端層                            │
│            (Angular/React Dashboard)                │
└─────────────────┬───────────────────────────────────┘
                  │ HTTPS/REST API
┌─────────────────▼───────────────────────────────────┐
│               應用程式層                              │
│    ┌──────────────────────────────────────┐        │
│    │      路由與中介軟體層                  │        │
│    │  (Router, Auth, Permission)          │        │
│    └────────────┬─────────────────────────┘        │
│                 │                                   │
│    ┌────────────▼─────────────────────────┐        │
│    │         控制器層                       │        │
│    │  (9 Controllers: Auth, Target...)    │        │
│    └────────────┬─────────────────────────┘        │
│                 │                                   │
│    ┌────────────▼─────────────────────────┐        │
│    │        業務邏輯層                      │        │
│    │  (22 Services: Detect, Monitor...)   │        │
│    └────────────┬─────────────────────────┘        │
│                 │                                   │
│    ┌────────────▼─────────────────────────┐        │
│    │        資料模型層                      │        │
│    │  (Entities: User, Target, Device...) │        │
│    └────────────┬─────────────────────────┘        │
└─────────────────┼───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│                資料儲存層                             │
│  ┌─────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  MySQL  │  │ TimescaleDB  │  │Elasticsearch │  │
│  │ (配置)  │  │  (時序資料)   │  │   (日誌)     │  │
│  └─────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────┘
```

### 3.2 目錄結構

```
log-detect-backend/
├── main.go                 # 應用程式進入點
├── config.yml             # 主要配置檔
├── setting.yml            # 監控目標配置
│
├── clients/               # 外部服務客戶端
│   ├── mysql.go           # MySQL 連線管理
│   ├── es.go              # Elasticsearch 客戶端
│   └── timescale.go       # TimescaleDB 連線
│
├── entities/              # 資料模型定義（20+ 實體）
│   ├── user.go            # 使用者、角色、權限
│   ├── targets.go         # 監控目標、索引
│   ├── devices.go         # 裝置管理
│   ├── history.go         # 歷史記錄
│   └── elasticsearch.go   # ES 監控模型
│
├── services/              # 業務邏輯層（22 個服務）
│   ├── auth.go            # 認證與授權
│   ├── detect.go          # 核心監控邏輯
│   ├── center.go          # Cron 作業管理
│   ├── device.go          # 裝置管理
│   ├── target.go          # 目標管理
│   ├── indices.go         # 索引管理
│   ├── history.go         # 歷史資料管理
│   ├── batch_writer.go    # 批次寫入服務
│   ├── es_monitor.go      # ES 健康監控
│   ├── es_scheduler.go    # ES 監控排程器
│   ├── mail.go            # 郵件服務
│   └── dashboard.go       # 儀表板資料聚合
│
├── controller/            # HTTP 請求處理器（9 個控制器）
│   ├── auth.go            # 認證端點
│   ├── target.go          # 目標管理端點
│   ├── device.go          # 裝置管理端點
│   ├── elasticsearch.go   # ES 監控端點
│   └── dashboard.go       # 儀表板端點
│
├── middleware/            # 中介軟體
│   └── auth.go            # JWT 驗證、權限檢查
│
├── router/                # 路由配置
│   └── router.go          # API 路由定義
│
├── models/                # 請求/回應模型
│   └── response.go        # 通用回應結構
│
├── global/                # 全域狀態
│   └── global.go          # 全域變數與配置
│
├── structs/               # 配置結構
│   └── env.go             # 環境配置定義
│
├── utils/                 # 工具函數
│   └── utils.go           # CORS 等輔助功能
│
├── handler/               # 錯誤處理
│   └── error.go           # 錯誤日誌記錄
│
├── log/                   # 應用程式日誌
│
├── docs/                  # 文件
│   ├── specs_cn/          # 規格文件（本文件）
│   ├── swagger.json       # Swagger API 文件
│   └── ...                # 其他文件
│
└── scripts/               # 輔助腳本
    └── *.sql              # 資料庫遷移腳本
```

---

## 4. 系統運作流程

### 4.1 系統啟動流程

```
1. main.go 啟動
   ↓
2. 載入配置檔 (config.yml)
   ↓
3. 初始化資料庫連線
   │ ├─ MySQL 連線
   │ ├─ TimescaleDB 連線
   │ └─ Elasticsearch 連線
   ↓
4. 執行資料庫遷移 (RunMigrations)
   ↓
5. 初始化認證系統
   │ ├─ 建立預設角色與權限
   │ └─ 建立預設管理員帳號
   ↓
6. 初始化批次寫入器 (BatchWriter)
   ↓
7. 載入監控排程器
   │ ├─ 初始化 Cron 排程器
   │ ├─ 載入所有啟用的監控目標
   │ └─ 初始化 ES 監控排程器
   ↓
8. 載入路由與中介軟體
   ↓
9. 啟動 HTTP 服務器 (預設 :8006)
```

### 4.2 裝置監控流程

```
1. Cron 作業觸發 (依配置頻率)
   ↓
2. 執行 Detect() 函數
   ├─ 計算查詢時間範圍
   ├─ 查詢 Elasticsearch 取得裝置清單
   ├─ 從資料庫取得已知裝置清單
   └─ 比對兩份清單
   ↓
3. 偵測變化
   ├─ 新增裝置：建立裝置記錄
   ├─ 離線裝置：標記為離線
   └─ 持續線上：更新狀態
   ↓
4. 建立歷史記錄
   ├─ 儲存至 MySQL (history 表)
   └─ 加入批次寫入佇列
   ↓
5. 產生警報（如有離線裝置）
   └─ 發送電子郵件通知
   ↓
6. 批次寫入 TimescaleDB
   └─ 儲存至 device_metrics 超表
```

### 4.3 API 請求流程

```
1. 客戶端發送 HTTP 請求
   ↓
2. 路由匹配 (router/router.go)
   ↓
3. 中介軟體鏈處理
   ├─ AuthMiddleware: 驗證 JWT 令牌
   └─ PermissionMiddleware: 檢查資源權限
   ↓
4. 控制器處理請求
   └─ 呼叫對應的服務函數
   ↓
5. 服務層執行業務邏輯
   └─ 操作資料庫、呼叫外部服務
   ↓
6. 返回 JSON 回應
   └─ 標準格式：{code, message, data}
```

---

## 5. 關鍵業務流程

### 5.1 使用者認證流程

1. **登入請求**：POST /auth/login {username, password}
2. **密碼驗證**：bcrypt 比對資料庫雜湊值
3. **權限載入**：查詢使用者角色與權限
4. **令牌生成**：產生 JWT（包含 user_id, role_id, 過期時間）
5. **令牌返回**：回傳給客戶端，儲存於 localStorage
6. **後續請求**：每次請求帶上 Authorization: Bearer {token}
7. **令牌驗證**：中介軟體驗證簽章、過期時間、權限

### 5.2 監控目標建立流程

1. **建立索引**：定義 Elasticsearch 索引模式、查詢欄位、監控頻率
2. **建立目標**：指定警報收件人、主旨
3. **關聯索引**：將索引與目標關聯（多對多）
4. **自動排程**：系統自動產生 Cron 表達式並註冊作業
5. **作業記錄**：將 Cron Entry ID 儲存至 cron_lists 表
6. **定期執行**：按排程執行監控檢測

### 5.3 警報產生與發送流程

1. **偵測異常**：監控發現離線裝置或 ES 指標超過閾值
2. **建立警報記錄**：寫入 alert_history 表
3. **檢查去重視窗**：避免短時間內重複發送（預設 5 分鐘）
4. **組裝郵件內容**：使用 HTML 模板，列出異常裝置清單
5. **發送郵件**：透過 SMTP（Gmail 或自訂伺服器）
6. **記錄發送狀態**：寫入 mail_history 表

---

## 6. 系統限制與注意事項

### 6.1 效能限制

| 項目        | 限制      | 說明            |
| --------- | ------- | ------------- |
| 並發 API 請求 | ~1000/秒 | 單機部署，視硬體而定    |
| 批次寫入延遲    | 最高 5 秒  | 資料可能有最多 5 秒延遲 |
| Cron 最小間隔 | 1 分鐘    | 由 cron 表達式限制  |
| ES 監控最小間隔 | 10 秒    | 避免過度查詢 ES 叢集  |
| JWT 過期時間  | 24 小時   | 固定值，需定期更新令牌   |

### 6.2 資料保留

- **MySQL history 表**：建議定期封存至 history_archive
- **TimescaleDB 超表**：自動分區，建議設定資料保留政策
- **日誌檔案**：按月輪轉，需定期清理

### 6.3 安全注意事項

- **JWT 密鑰**：必須變更預設值並妥善保管
- **SSL/TLS**：生產環境應啟用 HTTPS
- **ES 憑證驗證**：目前停用 InsecureSkipVerify，生產環境應啟用
- **資料庫密碼**：不應明文寫在配置檔，建議使用環境變數或密鑰管理服務

---

## 7. 系統度量指標

### 7.1 當前系統規模

| 指標     | 數值                         |
| ------ | -------------------------- |
| 程式碼行數  | ~20,000 行                  |
| 服務數量   | 22 個                       |
| 控制器數量  | 9 個                        |
| API 端點 | 60+ 個                      |
| 資料模型   | 20+ 個                      |
| 資料表數量  | MySQL: 15+, TimescaleDB: 3 |

### 7.2 監控能力

| 指標        | 說明           |
| --------- | ------------ |
| 支援監控裝置數   | 無上限（視 ES 效能） |
| 支援監控目標數   | 無上限          |
| 支援 ES 叢集數 | 無上限          |
| 歷史資料查詢範圍  | 取決於資料保留政策    |

---

## 8. 未來發展方向

### 8.1 短期計劃（1-3 個月）

- [ ] 優化批次寫入效能
- [ ] 新增更多警報通知通道（Slack、Teams）
- [ ] 強化 API 輸入驗證
- [ ] 新增速率限制中介軟體
- [ ] 完善單元測試覆蓋率

### 8.2 中期計劃（3-6 個月）

- [ ] 支援分散式部署
- [ ] 新增 Redis 快取層
- [ ] 實作非同步郵件發送佇列
- [ ] 支援自訂警報規則引擎
- [ ] 新增 WebSocket 即時通知

### 8.3 長期計劃（6-12 個月）

- [ ] 機器學習異常檢測
- [ ] 多租戶支援
- [ ] 事件溯源與 CQRS 架構
- [ ] 雲端原生部署支援（K8s）
- [ ] 國際化與多語系支援

---

## 9. 相關文件

本文件為系統概述，完整的 SDD 文件包含以下部分：

1. **系統概述**（本文件）
2. **架構設計** - 詳細的系統架構、組件互動、資料流程
3. **API 規格** - 完整的 API 端點定義、請求/回應格式
4. **資料庫設計** - 資料表結構、ER 圖、索引策略
5. **安全設計** - 認證、授權、加密、安全最佳實踐
6. **部署與維運** - 部署架構、監控、日誌、備份策略
7. **開發指南** - 開發環境設定、編碼規範、測試策略

---

## 10. 文件變更歷史

| 版本  | 日期         | 變更內容            | 作者     |
| --- | ---------- | --------------- | ------ |
| 2.0 | 2025-11-18 | SDD 重構，完整改寫系統概述 | Claude |
| 1.0 | 2024-10-29 | 初始版本            | 原始團隊   |

---

**文件結束**
