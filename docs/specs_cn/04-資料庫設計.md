# Log Detect Backend - 資料庫設計文件

## 文件資訊

| 項目 | 內容 |
|------|------|
| 文件版本 | 2.0 |
| 最後更新 | 2025-11-18 |
| 文件類型 | 軟體設計文件 (SDD) - 資料庫設計 |

---

## 1. 資料庫架構概覽

### 1.1 多資料庫架構

本系統採用**多資料庫架構**，針對不同類型的資料使用最適合的資料庫：

```
┌─────────────────────────────────────────────────────────┐
│                  應用程式層                               │
└────────┬─────────────────┬──────────────────┬───────────┘
         │                 │                  │
    ┌────▼─────┐    ┌─────▼──────┐    ┌─────▼─────┐
    │  MySQL   │    │TimescaleDB │    │Elasticsearch│
    │          │    │            │    │             │
    │  配置    │    │  時序資料   │    │   日誌     │
    │  元資料  │    │  監控指標   │    │   事件     │
    └──────────┘    └────────────┘    └────────────┘
```

### 1.2 資料庫分工

| 資料庫 | 類型 | 用途 | 主要資料 |
|--------|------|------|---------|
| MySQL | 關聯式資料庫 | 系統配置與元資料 | 使用者、角色、權限、監控目標、裝置清單、歷史記錄 |
| TimescaleDB | 時序資料庫 | 監控指標儲存 | 裝置指標、ES 指標、警報歷史 |
| Elasticsearch | 搜尋引擎 | 日誌儲存與查詢 | 應用程式日誌、事件資料 |

---

## 2. MySQL 資料庫設計

### 2.1 資料庫資訊

- **資料庫名稱**: `logdetect`
- **字元集**: `utf8mb4`
- **排序規則**: `utf8mb4_unicode_ci`
- **引擎**: InnoDB
- **時區**: UTC

### 2.2 資料表列表

| 編號 | 資料表名稱 | 用途 | 估計筆數 |
|------|-----------|------|---------|
| 1 | users | 使用者帳號 | < 1,000 |
| 2 | roles | 使用者角色 | < 10 |
| 3 | permissions | 系統權限 | < 100 |
| 4 | role_permissions | 角色權限關聯 | < 500 |
| 5 | devices | 監控裝置清單 | 10,000 - 100,000 |
| 6 | targets | 監控目標 | < 100 |
| 7 | indices | ES 索引配置 | < 100 |
| 8 | indices_targets | 索引目標關聯 | < 500 |
| 9 | receivers | 郵件接收者 | < 100 |
| 10 | history | 監控歷史記錄 | 100,000+ |
| 11 | history_archive | 歷史記錄封存 | 1,000,000+ |
| 12 | history_daily_stats | 每日統計 | 10,000+ |
| 13 | mail_history | 郵件發送記錄 | 10,000+ |
| 14 | alert_history | 警報記錄 | 10,000+ |
| 15 | cron_lists | Cron 作業清單 | < 500 |
| 16 | elasticsearch_monitors | ES 監控器配置 | < 50 |

### 2.3 核心資料表設計

#### 2.3.1 users（使用者）

```sql
CREATE TABLE `users` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(50) NOT NULL UNIQUE,
  `email` VARCHAR(100) NOT NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL COMMENT 'bcrypt 雜湊',
  `role_id` INT UNSIGNED NOT NULL,
  `is_active` BOOLEAN DEFAULT TRUE,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_username` (`username`),
  INDEX `idx_email` (`email`),
  INDEX `idx_role_id` (`role_id`),
  FOREIGN KEY (`role_id`) REFERENCES `roles`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='使用者帳號表';
```

**欄位說明**：
- `password`: 使用 bcrypt 雜湊，不可逆加密
- `is_active`: 軟刪除標記，false 時無法登入
- `role_id`: 外鍵關聯到 roles 表

#### 2.3.2 roles（角色）

```sql
CREATE TABLE `roles` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(50) NOT NULL UNIQUE,
  `description` VARCHAR(255),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='使用者角色表';
```

**預設資料**：
- `admin`: 系統管理員（所有權限）
- `operator`: 維運人員（CRUD 權限）
- `user`: 一般使用者（唯讀權限）

#### 2.3.3 permissions（權限）

```sql
CREATE TABLE `permissions` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(100) NOT NULL UNIQUE COMMENT '權限名稱，格式：resource.action',
  `resource` VARCHAR(50) NOT NULL COMMENT '資源名稱',
  `action` VARCHAR(50) NOT NULL COMMENT '操作：create, read, update, delete',
  `description` VARCHAR(255),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_name` (`name`),
  INDEX `idx_resource` (`resource`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系統權限表';
```

**權限命名規則**：`{resource}.{action}`

範例：
- `device.create` - 建立裝置權限
- `target.read` - 讀取監控目標權限
- `elasticsearch.update` - 更新 ES 監控器權限

#### 2.3.4 role_permissions（角色權限關聯）

```sql
CREATE TABLE `role_permissions` (
  `role_id` INT UNSIGNED NOT NULL,
  `permission_id` INT UNSIGNED NOT NULL,
  PRIMARY KEY (`role_id`, `permission_id`),
  FOREIGN KEY (`role_id`) REFERENCES `roles`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`permission_id`) REFERENCES `permissions`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色權限關聯表（多對多）';
```

#### 2.3.5 devices（裝置）

```sql
CREATE TABLE `devices` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `device_group` VARCHAR(100) NOT NULL COMMENT '裝置群組',
  `name` VARCHAR(255) NOT NULL COMMENT '裝置名稱',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_group_name` (`device_group`, `name`),
  INDEX `idx_device_group` (`device_group`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='監控裝置清單';
```

**索引說明**：
- `uk_group_name`: 複合唯一鍵，確保同群組內裝置名稱不重複
- `idx_device_group`: 加速按群組查詢

#### 2.3.6 targets（監控目標）

```sql
CREATE TABLE `targets` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `subject` VARCHAR(255) NOT NULL COMMENT '警報郵件主旨',
  `to` JSON NOT NULL COMMENT '收件人郵箱列表',
  `enable` BOOLEAN DEFAULT TRUE COMMENT '是否啟用監控',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_enable` (`enable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='監控目標配置';
```

**JSON 範例**（`to` 欄位）：
```json
["admin@example.com", "ops@example.com"]
```

#### 2.3.7 indices（索引配置）

```sql
CREATE TABLE `indices` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `pattern` VARCHAR(255) NOT NULL COMMENT 'ES 索引模式',
  `device_group` VARCHAR(100) NOT NULL COMMENT '裝置群組',
  `logname` VARCHAR(100) NOT NULL COMMENT '日誌名稱',
  `period` ENUM('minutes', 'hours') NOT NULL COMMENT '監控週期類型',
  `unit` INT NOT NULL COMMENT '監控頻率',
  `field` VARCHAR(255) NOT NULL COMMENT '聚合欄位',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_logname` (`logname`),
  INDEX `idx_device_group` (`device_group`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Elasticsearch 索引配置';
```

**欄位範例**：
- `pattern`: `logstash-prod-*`
- `field`: `host.keyword`（ES 中的裝置名稱欄位）
- `period` + `unit`: `minutes` + `5` = 每 5 分鐘監控一次

#### 2.3.8 indices_targets（索引目標關聯）

```sql
CREATE TABLE `indices_targets` (
  `index_id` INT UNSIGNED NOT NULL,
  `target_id` INT UNSIGNED NOT NULL,
  PRIMARY KEY (`index_id`, `target_id`),
  FOREIGN KEY (`index_id`) REFERENCES `indices`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`target_id`) REFERENCES `targets`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='索引與目標關聯表（多對多）';
```

#### 2.3.9 history（監控歷史）

```sql
CREATE TABLE `history` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `logname` VARCHAR(100) NOT NULL,
  `device_group` VARCHAR(100) NOT NULL,
  `name` VARCHAR(255) NOT NULL COMMENT '裝置名稱',
  `status` ENUM('online', 'offline', 'warning', 'error') NOT NULL,
  `lost` ENUM('true', 'false') DEFAULT 'false' COMMENT '是否遺失',
  `lost_num` INT DEFAULT 0 COMMENT '遺失數量',
  `date` DATE NOT NULL,
  `time` TIME NOT NULL,
  `date_time` DATETIME NOT NULL,
  `timestamp` BIGINT NOT NULL COMMENT 'Unix 時間戳記',
  `period` VARCHAR(20),
  `unit` INT,
  `response_time` BIGINT COMMENT '回應時間（毫秒）',
  `data_count` BIGINT COMMENT '資料筆數',
  `error_msg` TEXT,
  `error_code` VARCHAR(50),
  `metadata` JSON COMMENT '額外資訊',
  INDEX `idx_logname` (`logname`),
  INDEX `idx_device_group` (`device_group`),
  INDEX `idx_name` (`name`),
  INDEX `idx_date_time` (`date_time`),
  INDEX `idx_timestamp` (`timestamp`),
  INDEX `idx_status` (`status`),
  INDEX `idx_composite` (`logname`, `device_group`, `date_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='監控歷史記錄';
```

**索引策略**：
- `idx_composite`: 複合索引，加速常見查詢模式
- `idx_timestamp`: 時間範圍查詢
- 定期封存舊資料至 `history_archive` 表

#### 2.3.10 elasticsearch_monitors（ES 監控器）

```sql
CREATE TABLE `elasticsearch_monitors` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(100) NOT NULL COMMENT '監控器名稱',
  `host` VARCHAR(255) NOT NULL,
  `port` INT DEFAULT 9200,
  `username` VARCHAR(100),
  `password` VARCHAR(255),
  `enable_auth` BOOLEAN DEFAULT FALSE,
  `check_type` VARCHAR(100) COMMENT '檢查類型：health,performance,capacity',
  `interval` INT DEFAULT 60 COMMENT '檢查間隔（秒）',
  `enable_monitor` BOOLEAN DEFAULT TRUE,
  `receivers` JSON COMMENT '收件人列表',
  `subject` VARCHAR(255),
  `description` TEXT,

  -- 警報閾值
  `cpu_usage_high` DECIMAL(5,2) DEFAULT 75.00,
  `cpu_usage_critical` DECIMAL(5,2) DEFAULT 85.00,
  `memory_usage_high` DECIMAL(5,2) DEFAULT 80.00,
  `memory_usage_critical` DECIMAL(5,2) DEFAULT 90.00,
  `disk_usage_high` DECIMAL(5,2) DEFAULT 85.00,
  `disk_usage_critical` DECIMAL(5,2) DEFAULT 95.00,
  `response_time_high` BIGINT DEFAULT 3000,
  `response_time_critical` BIGINT DEFAULT 10000,
  `unassigned_shards_threshold` INT DEFAULT 1,
  `alert_threshold` JSON COMMENT '閾值備份（JSON 格式）',
  `alert_dedupe_window` INT DEFAULT 300 COMMENT '警報去重視窗（秒）',

  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX `idx_enable_monitor` (`enable_monitor`),
  INDEX `idx_host` (`host`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Elasticsearch 監控器配置';
```

### 2.4 ER 圖

```
┌─────────────┐        ┌──────────────┐       ┌──────────────┐
│   users     │───────▶│    roles     │──────▶│ permissions  │
│             │ N:1    │              │ N:M   │              │
│ - id        │        │ - id         │       │ - id         │
│ - username  │        │ - name       │       │ - name       │
│ - password  │        └──────────────┘       │ - resource   │
│ - role_id   │                               │ - action     │
│ - is_active │                               └──────────────┘
└─────────────┘                                      △
                                                     │ N:M
                                            ┌────────┴────────┐
                                            │role_permissions │
                                            └─────────────────┘

┌──────────────┐      ┌──────────────────┐      ┌──────────────┐
│   targets    │◀────▶│ indices_targets  │◀────▶│   indices    │
│              │ N:M  │                  │ N:M  │              │
│ - id         │      │ - target_id      │      │ - id         │
│ - subject    │      │ - index_id       │      │ - pattern    │
│ - to (JSON)  │      └──────────────────┘      │ - logname    │
│ - enable     │                                │ - period     │
└──────────────┘                                │ - unit       │
                                                │ - field      │
                                                └──────────────┘
                                                       │
                                                       │ 1:N
                                                       ▼
                                                ┌──────────────┐
                                                │   devices    │
                                                │              │
                                                │ - id         │
                                                │ - name       │
                                                │ - group      │
                                                └──────────────┘
```

---

## 3. TimescaleDB 設計

### 3.1 資料庫資訊

- **資料庫名稱**: `monitoring`
- **字元集**: UTF8
- **時區**: Asia/Taipei
- **連線池**: Max 100 connections

### 3.2 超表（Hypertables）

#### 3.2.1 device_metrics（裝置指標）

```sql
CREATE TABLE device_metrics (
  time TIMESTAMPTZ NOT NULL,
  device_id INT,
  device_group VARCHAR(100),
  device_name VARCHAR(255),
  logname VARCHAR(100),
  status VARCHAR(20),
  lost BOOLEAN,
  response_time BIGINT,
  data_count BIGINT,
  error_msg TEXT,
  error_code VARCHAR(50),
  metadata JSONB
);

-- 建立超表，按時間分區（預設 7 天一個 chunk）
SELECT create_hypertable('device_metrics', 'time');

-- 建立索引
CREATE INDEX idx_dm_device ON device_metrics (device_name, time DESC);
CREATE INDEX idx_dm_group ON device_metrics (device_group, time DESC);
CREATE INDEX idx_dm_logname ON device_metrics (logname, time DESC);
CREATE INDEX idx_dm_status ON device_metrics (status, time DESC);
```

**資料保留政策**：
```sql
-- 自動刪除 90 天前的資料
SELECT add_retention_policy('device_metrics', INTERVAL '90 days');
```

**壓縮策略**：
```sql
-- 壓縮 7 天前的資料
ALTER TABLE device_metrics SET (
  timescaledb.compress,
  timescaledb.compress_segmentby = 'device_name, device_group'
);
SELECT add_compression_policy('device_metrics', INTERVAL '7 days');
```

#### 3.2.2 es_metrics（ES 指標）

```sql
CREATE TABLE es_metrics (
  time TIMESTAMPTZ NOT NULL,
  monitor_id INT,
  status VARCHAR(20),
  cluster_name VARCHAR(100),
  cluster_status VARCHAR(20),
  response_time BIGINT,

  -- 效能指標
  cpu_usage DECIMAL(5,2),
  memory_usage DECIMAL(5,2),
  disk_usage DECIMAL(5,2),

  -- 叢集資訊
  node_count INT,
  data_node_count INT,
  query_latency BIGINT,
  indexing_rate DECIMAL(10,2),
  search_rate DECIMAL(10,2),

  -- 資料統計
  total_indices INT,
  total_documents BIGINT,
  total_size_bytes BIGINT,

  -- 分片資訊
  active_shards INT,
  relocating_shards INT,
  unassigned_shards INT,

  -- 警報資訊
  error_message TEXT,
  warning_message TEXT,
  metadata JSONB
);

SELECT create_hypertable('es_metrics', 'time');

CREATE INDEX idx_esm_monitor ON es_metrics (monitor_id, time DESC);
CREATE INDEX idx_esm_cluster ON es_metrics (cluster_name, time DESC);
CREATE INDEX idx_esm_status ON es_metrics (cluster_status, time DESC);
```

**聚合查詢範例**：
```sql
-- 取得最近 1 小時的平均 CPU 使用率
SELECT
  time_bucket('5 minutes', time) AS bucket,
  monitor_id,
  AVG(cpu_usage) AS avg_cpu,
  MAX(cpu_usage) AS max_cpu
FROM es_metrics
WHERE time > NOW() - INTERVAL '1 hour'
GROUP BY bucket, monitor_id
ORDER BY bucket DESC;
```

#### 3.2.3 alert_history（警報歷史）

```sql
CREATE TABLE alert_history (
  time TIMESTAMPTZ NOT NULL,
  alert_id SERIAL,
  monitor_id INT,
  alert_type VARCHAR(50),
  severity VARCHAR(20),
  message TEXT,
  status VARCHAR(20),
  cluster_name VARCHAR(100),
  threshold_value DECIMAL(10,2),
  actual_value DECIMAL(10,2),
  resolved_at TIMESTAMPTZ,
  resolved_by VARCHAR(100),
  resolution_note TEXT,
  acknowledged_at TIMESTAMPTZ,
  acknowledged_by VARCHAR(100),
  metadata JSONB
);

SELECT create_hypertable('alert_history', 'time');

CREATE INDEX idx_ah_monitor ON alert_history (monitor_id, time DESC);
CREATE INDEX idx_ah_status ON alert_history (status, time DESC);
CREATE INDEX idx_ah_severity ON alert_history (severity, time DESC);
```

### 3.3 連續聚合（Continuous Aggregates）

```sql
-- 每小時統計
CREATE MATERIALIZED VIEW device_metrics_hourly
WITH (timescaledb.continuous) AS
SELECT
  time_bucket('1 hour', time) AS bucket,
  device_group,
  logname,
  COUNT(*) AS total_checks,
  COUNT(*) FILTER (WHERE status = 'online') AS online_count,
  COUNT(*) FILTER (WHERE status = 'offline') AS offline_count,
  AVG(response_time) AS avg_response_time,
  MAX(response_time) AS max_response_time
FROM device_metrics
GROUP BY bucket, device_group, logname;

-- 自動更新策略
SELECT add_continuous_aggregate_policy('device_metrics_hourly',
  start_offset => INTERVAL '3 hours',
  end_offset => INTERVAL '1 hour',
  schedule_interval => INTERVAL '1 hour');
```

---

## 4. Elasticsearch 索引設計

### 4.1 索引命名規則

本系統查詢的 Elasticsearch 索引由外部日誌收集工具（如 Logstash）建立，常見模式：

- `logstash-{環境}-{YYYY.MM.DD}`
- `logs-{服務名}-{YYYY.MM.DD}`
- 自訂模式（在 `indices` 表中配置）

### 4.2 查詢欄位要求

監控查詢需要以下欄位：
- `@timestamp`: 時間戳記（必須）
- 裝置識別欄位（如 `host.keyword`, `hostname.keyword`）
- 其他篩選欄位（可選）

### 4.3 查詢範例

```json
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "@timestamp": {
              "gte": "2024-01-01T00:00:00Z",
              "lte": "2024-01-01T00:05:00Z"
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "devices": {
      "terms": {
        "field": "host.keyword",
        "size": 10000
      }
    }
  }
}
```

---

## 5. 資料流向

```
┌──────────────┐
│ Detect()     │ 監控偵測
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ MySQL        │ 即時寫入 history 表
│ history      │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ BatchWriter  │ 批次累積（記憶體）
│ Queue        │
└──────┬───────┘
       │ 每 50 筆或 5 秒
       ▼
┌──────────────┐
│ TimescaleDB  │ 批次寫入 device_metrics
│ device_metrics
└──────────────┘
```

---

## 6. 資料保留與封存策略

### 6.1 MySQL

| 資料表 | 保留期限 | 封存策略 |
|--------|---------|---------|
| history | 30 天 | 移至 history_archive |
| mail_history | 90 天 | 刪除 |
| alert_history | 90 天 | 移至 TimescaleDB |

**封存腳本**：
```sql
-- 封存 30 天前的 history
INSERT INTO history_archive
SELECT * FROM history
WHERE date < DATE_SUB(CURDATE(), INTERVAL 30 DAY);

DELETE FROM history
WHERE date < DATE_SUB(CURDATE(), INTERVAL 30 DAY);
```

### 6.2 TimescaleDB

使用內建的自動保留與壓縮策略：

```sql
-- 保留 90 天
SELECT add_retention_policy('device_metrics', INTERVAL '90 days');

-- 壓縮 7 天前的資料
SELECT add_compression_policy('device_metrics', INTERVAL '7 days');
```

### 6.3 Elasticsearch

由 Elasticsearch ILM（Index Lifecycle Management）管理，非本系統範圍。

---

## 7. 效能最佳化

### 7.1 MySQL 最佳化

#### 連線池設定
```yaml
database:
  max_idle: 10      # 最大閒置連線
  max_open_conn: 100 # 最大開啟連線
  max_life_time: 1h  # 連線最大存活時間
```

#### 索引策略
- 所有外鍵建立索引
- 常用查詢欄位建立複合索引
- 避免在大表上建立過多索引

#### 查詢最佳化
- 使用 `LIMIT` 限制結果集
- 避免 `SELECT *`
- 使用預備語句（Prepared Statements）

### 7.2 TimescaleDB 最佳化

#### Chunk 大小調整
```sql
-- 調整分區間隔為 1 天
SELECT set_chunk_time_interval('device_metrics', INTERVAL '1 day');
```

#### 壓縮比率
- 典型壓縮比：10:1 ~ 20:1
- 壓縮後查詢效能略降，但儲存空間大幅減少

### 7.3 批次寫入最佳化

**配置**：
```yaml
batch_writer:
  batch_size: 50      # 批次大小
  flush_interval: 5s  # 刷新間隔
```

**效能提升**：
- 減少資料庫往返次數
- 提高寫入吞吐量
- 降低資料庫負載

---

## 8. 備份策略

### 8.1 MySQL 備份

**方案**: mysqldump + binlog

```bash
# 每日完整備份
mysqldump -u root -p logdetect > backup_$(date +%Y%m%d).sql

# binlog 持續備份（用於時間點復原）
mysqlbinlog --read-from-remote-server --host=localhost --raw
```

**保留期限**: 完整備份 30 天，binlog 7 天

### 8.2 TimescaleDB 備份

**方案**: pg_dump

```bash
# 每日備份
pg_dump -U postgres -d monitoring -Fc > monitoring_$(date +%Y%m%d).dump
```

**保留期限**: 30 天

---

## 9. 資料庫監控

### 9.1 監控指標

| 指標 | 警報閾值 | 說明 |
|------|---------|------|
| 連線數 | > 80% | 連線池接近上限 |
| 慢查詢 | > 1 秒 | 查詢效能問題 |
| 資料表大小 | > 100GB | 需要封存 |
| 磁碟使用率 | > 80% | 儲存空間不足 |
| Replication Lag | > 10秒 | 主從延遲 |

### 9.2 效能分析工具

- **MySQL**: `EXPLAIN` 分析查詢計畫
- **TimescaleDB**: `timescaledb_information` 檢視
- **慢查詢日誌**: 記錄超過 1 秒的查詢

---

**文件結束**
