# Log Detect 後端 - 架構與組件互動圖 (Architecture & Component Interaction Diagram)

## 系統架構概覽 (System Architecture Overview)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          CLIENT LAYER (Frontend)                         │
│                          客戶端層(前端)                                    │
│                    Angular/React Dashboard                              │
│                                                                          │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                        HTTP REST API (Gin)
                                 │
┌────────────────────────────────▼────────────────────────────────────────┐
│                     ROUTING & MIDDLEWARE LAYER                           │
│                     路由與中介層                                           │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ Router (router/router.go)                                        │  │
│  │ 路由器                                                             │  │
│  │  - Route Groups: /auth, /Target, /Device, /Indices, /Receiver   │  │
│  │  - 路由群組: /auth, /Target, /Device, /Indices, /Receiver        │  │
│  │  - Middleware Chain: AuthMiddleware → PermissionMiddleware      │  │
│  │  - 中介鏈: 認證中介 → 權限中介                                       │  │
│  │  - Swagger API Documentation                                    │  │
│  │  - Swagger API 文件                                              │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ Middleware (middleware/auth.go)                                  │  │
│  │ 中介層                                                             │  │
│  │  - AuthMiddleware(): JWT token validation                        │  │
│  │  - 認證中介: JWT 令牌驗證                                           │  │
│  │  - OptionalAuthMiddleware(): Backward compatibility             │  │
│  │  - 可選認證中介: 向後相容性                                          │  │
│  │  - PermissionMiddleware(): RBAC enforcement                     │  │
│  │  - 權限中介: RBAC 強制執行                                          │  │
│  │  - RequireRole(), AdminOnly(): Role-based access               │  │
│  │  - 角色需求、僅限管理員: 基於角色的存取                               │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼────────────────────────────────────────┐
│                      CONTROLLER LAYER (9 Controllers)                    │
│                      控制器層 (9 個控制器)                                 │
│                                                                          │
│  auth.go          target.go        device.go        indices.go          │
│  認證              目標              裝置              索引                │
│  ├─ Login         ├─ GetAllTargets  ├─ GetAllDevices ├─ GetAllIndices   │
│  ├─ 登入           ├─ 取得所有目標     ├─ 取得所有裝置    ├─ 取得所有索引    │
│  ├─ Register      ├─ CreateTarget   ├─ CreateDevice  ├─ CreateIndices   │
│  ├─ 註冊           ├─ 建立目標        ├─ 建立裝置       ├─ 建立索引       │
│  ├─ GetProfile    ├─ UpdateTarget   ├─ UpdateDevice  ├─ UpdateIndices   │
│  ├─ 取得個人資料     ├─ 更新目標        ├─ 更新裝置       ├─ 更新索引       │
│  └─ RefreshToken  └─ DeleteTarget   └─ DeleteDevice  └─ DeleteIndices   │
│  └─ 刷新令牌        └─ 刪除目標        └─ 刪除裝置       └─ 刪除索引       │
│                                                                          │
│  receiver.go      history.go       elasticsearch.go  dashboard.go       │
│  接收器            歷史紀錄            Elasticsearch    儀表板             │
│  ├─ GetAllReceivers ├─ GetData      ├─ CreateMonitor  ├─ GetDashboard   │
│  ├─ 取得所有接收器   ├─ 取得資料       ├─ 建立監控器      ├─ 取得儀表板     │
│  ├─ CreateReceiver  ├─ GetLogname   ├─ GetStatus      ├─ GetStatistics  │
│  ├─ 建立接收器      ├─ 取得日誌名稱    ├─ 取得狀態        ├─ 取得統計資料   │
│  ├─ UpdateReceiver  └─ Monitoring   ├─ GetAlerts      └─ GetTrends      │
│  ├─ 更新接收器      └─ 監控           ├─ 取得警報        └─ 取得趨勢       │
│  └─ DeleteReceiver                  └─ TestConnection                    │
│  └─ 刪除接收器                       └─ 測試連線                          │
│                                                                          │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼────────────────────────────────────────┐
│               BUSINESS LOGIC LAYER (22 Services)                         │
│               業務邏輯層 (22 個服務)                                        │
│                                                                          │
│  ┌─ auth.go (Authentication & RBAC)                                    │
│  │  認證服務 (認證與 RBAC)                                               │
│  │   - HashPassword(), CheckPassword()                                │
│  │   - 雜湊密碼、檢查密碼                                                 │
│  │   - GenerateJWT(), ValidateJWT()                                  │
│  │   - 產生 JWT、驗證 JWT                                               │
│  │   - CreateDefaultRolesAndPermissions()                            │
│  │   - 建立預設角色與權限                                                │
│  │   - CheckPermission(), Login(), Register()                        │
│  │   - 檢查權限、登入、註冊                                              │
│  │                                                                    │
│  ┌─ detect.go (Core Monitoring Logic)                                │
│  │  偵測服務 (核心監控邏輯)                                              │
│  │   - Detect(): Query ES → Compare DB → Generate History            │
│  │   - 偵測: 查詢 ES → 比對資料庫 → 產生歷史紀錄                          │
│  │   - Device auto-discovery and anomaly detection                   │
│  │   - 裝置自動發現與異常偵測                                            │
│  │   - Email alert generation for offline devices                    │
│  │   - 離線裝置的電子郵件警報產生                                         │
│  │                                                                    │
│  ┌─ center.go (Cron Job Scheduler)                                   │
│  │  中心服務 (Cron 工作排程器)                                           │
│  │   - LoadCrontab(), ExecuteCrontab()                               │
│  │   - 載入 Crontab、執行 Crontab                                      │
│  │   - Control_center(): Bootstrap all targets                       │
│  │   - 控制中心: 啟動所有目標                                            │
│  │   - Dynamic cron job management                                   │
│  │   - 動態 cron 工作管理                                              │
│  │                                                                    │
│  ┌─ device.go, target.go, indices.go, receiver.go (CRUD Services)   │
│  │  裝置、目標、索引、接收器服務 (CRUD 服務)                              │
│  │   - Create, Read, Update, Delete operations                       │
│  │   - 建立、讀取、更新、刪除操作                                         │
│  │   - Database entity management                                    │
│  │   - 資料庫實體管理                                                   │
│  │                                                                    │
│  ┌─ history.go (Monitoring History)                                  │
│  │  歷史紀錄服務 (監控歷史)                                              │
│  │   - CreateHistory(), GetHistoryData()                             │
│  │   - 建立歷史紀錄、取得歷史資料                                         │
│  │   - TimescaleDB query support                                     │
│  │   - TimescaleDB 查詢支援                                           │
│  │   - Historical data retrieval                                     │
│  │   - 歷史資料檢索                                                     │
│  │                                                                    │
│  ┌─ mail.go (Email Service)                                          │
│  │  郵件服務 (電子郵件服務)                                              │
│  │   - Mail4(): HTML email generation                                │
│  │   - Mail4: HTML 電子郵件產生                                        │
│  │   - SMTP client configuration                                     │
│  │   - SMTP 客戶端設定                                                 │
│  │   - Alert notification delivery                                   │
│  │   - 警報通知遞送                                                     │
│  │                                                                    │
│  ┌─ batch_writer.go (Time-Series Data Pipeline)                      │
│  │  批次寫入器 (時間序列資料管線)                                         │
│  │   - AddHistory(): Batch queue accumulation                        │
│  │   - 新增歷史紀錄: 批次佇列累積                                         │
│  │   - flushDeviceMetrics(): TimescaleDB bulk insert                │
│  │   - 排清裝置指標: TimescaleDB 批次插入                                │
│  │   - flushESMetrics(): ES metrics batch write                      │
│  │   - 排清 ES 指標: ES 指標批次寫入                                     │
│  │   - Periodic flushing (size or time-based)                        │
│  │   - 定期排清 (基於大小或時間)                                         │
│  │                                                                    │
│  ┌─ es_monitor_service.go (ES Health Monitoring)                     │
│  │  ES 監控服務 (ES 健康監控)                                           │
│  │   - CreateESMonitor(), UpdateESMonitor()                          │
│  │   - 建立 ES 監控器、更新 ES 監控器                                    │
│  │   - GetESMonitorByID(), DeleteESMonitor()                         │
│  │   - 依 ID 取得 ES 監控器、刪除 ES 監控器                              │
│  │   - Configuration persistence                                     │
│  │   - 設定持久化                                                       │
│  │                                                                    │
│  ┌─ es_scheduler.go (ES Monitor Scheduling)                          │
│  │  ES 排程器 (ES 監控排程)                                             │
│  │   - InitESScheduler(): Singleton initialization                   │
│  │   - 初始化 ES 排程器: 單例初始化                                      │
│  │   - LoadAllMonitors(): Startup loading                            │
│  │   - 載入所有監控器: 啟動載入                                          │
│  │   - StartMonitor(), StopMonitor()                                 │
│  │   - 啟動監控器、停止監控器                                            │
│  │   - Time-based health check triggering                            │
│  │   - 基於時間的健康檢查觸發                                            │
│  │                                                                    │
│  ┌─ es_query.go (Elasticsearch Queries)                              │
│  │  ES 查詢服務 (Elasticsearch 查詢)                                   │
│  │   - SearchRequest(): DSL query execution                          │
│  │   - 搜尋請求: DSL 查詢執行                                           │
│  │   - Aggregation on configurable fields                            │
│  │   - 可設定欄位的聚合                                                 │
│  │   - Date range filtering                                          │
│  │   - 日期範圍篩選                                                     │
│  │                                                                    │
│  ├─ sqltable.go (Schema Migration)                                   │
│  ├─ SQL 表格服務 (綱要遷移)                                             │
│  ├─ setting.go (YAML Config Loading)                                │
│  ├─ 設定服務 (YAML 設定載入)                                            │
│  ├─ tools.go (Helper Functions)                                     │
│  ├─ 工具服務 (輔助函式)                                                 │
│  └─ dashboard.go (Analytics & Visualization)                         │
│  └─ 儀表板服務 (分析與視覺化)                                            │
│                                                                    │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼────────────────────────────────────────┐
│                  DATA MODEL LAYER (Entities & Models)                    │
│                  資料模型層 (實體與模型)                                    │
│                                                                          │
│  Authentication Models       Monitoring Models        Analytics Models   │
│  認證模型                     監控模型                  分析模型            │
│  ├─ User                    ├─ Target               ├─ History          │
│  ├─ 使用者                   ├─ 目標                  ├─ 歷史紀錄         │
│  ├─ Role                    ├─ Index                ├─ HistoryDailyStats│
│  ├─ 角色                     ├─ 索引                  ├─ 歷史每日統計     │
│  ├─ Permission              ├─ Device               ├─ AlertHistory     │
│  ├─ 權限                     ├─ 裝置                  ├─ 警報歷史         │
│  └─ LoginRequest            ├─ Receiver             └─ DashboardData    │
│  └─ 登入請求                 ├─ 接收器                └─ 儀表板資料       │
│                             ├─ IndicesTargets                          │
│                             ├─ 索引目標關聯                              │
│                             ├─ CronList                                │
│                             ├─ Cron 清單                                │
│                             ├─ MailHistory                             │
│                             ├─ 郵件歷史                                  │
│                             ├─ ElasticsearchMonitor                    │
│                             ├─ Elasticsearch 監控器                     │
│                             ├─ ESMetric                                │
│                             ├─ ES 指標                                  │
│                             └─ ESAlert                                 │
│                             └─ ES 警報                                  │
│                                                                          │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼────────────────────────────────────────┐
│                    CLIENT LAYER (Database Connections)                   │
│                    客戶端層 (資料庫連線)                                    │
│                                                                          │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌───────────────┐  │
│  │   MySQL (GORM)       │  │  TimescaleDB (SQL)   │  │ Elasticsearch │  │
│  ├──────────────────────┤  ├──────────────────────┤  ├───────────────┤  │
│  │ - Database: logdetect│  │ - Database: monitoring│ │ - ES v8        │  │
│  │ - 資料庫: logdetect   │  │ - 資料庫: monitoring  │  │ - ES v8        │  │
│  │ - Connection pooling │  │ - Time-series data   │  │ - Health check │  │
│  │ - 連線池              │  │ - 時間序列資料         │  │ - 健康檢查      │  │
│  │ - Transaction support│  │ - Hypertable storage │  │ - SSL/TLS      │  │
│  │ - 交易支援            │  │ - 超表儲存            │  │ - SSL/TLS      │  │
│  │ - AutoMigrate schema │  │ - Batch insert       │  │ - Auth support │  │
│  │ - 自動遷移綱要         │  │ - 批次插入            │  │ - 認證支援      │  │
│  │                      │  │ - High compression   │  │ - DSL queries  │  │
│  │                      │  │ - 高壓縮              │  │ - DSL 查詢     │  │
│  │ Tables:              │  │                      │  │                │  │
│  │ 資料表:               │  │ Tables:              │  │ Indices:       │  │
│  │ ├─ users             │  │ 資料表:               │  │ 索引:          │  │
│  │ ├─ 使用者             │  │ ├─ device_metrics    │  │ ├─ logs*       │  │
│  │ ├─ roles             │  │ ├─ 裝置指標           │  │ ├─ 日誌*        │  │
│  │ ├─ 角色               │  │ ├─ es_metrics        │  │ ├─ events*     │  │
│  │ ├─ permissions       │  │ ├─ ES 指標            │  │ ├─ 事件*        │  │
│  │ ├─ 權限               │  │ └─ alert_history     │  │ └─ monitoring* │  │
│  │ ├─ devices           │  │ └─ 警報歷史           │  │ └─ 監控*        │  │
│  │ ├─ 裝置               │  │                      │  │                │  │
│  │ ├─ targets           │  │ Connection Pool:     │  │ Features:      │  │
│  │ ├─ 目標               │  │ 連線池:               │  │ 功能:          │  │
│  │ ├─ indices           │  │ ├─ Max Idle: 10      │  │ ├─ Aggregation │  │
│  │ ├─ 索引               │  │ ├─ 最大閒置: 10       │  │ ├─ 聚合         │  │
│  │ ├─ history           │  │ ├─ Max Open: 100     │  │ ├─ Filtering   │  │
│  │ ├─ 歷史紀錄           │  │ ├─ 最大開啟: 100      │  │ ├─ 篩選         │  │
│  │ ├─ alert_history     │  │ └─ Max Lifetime: 1h  │  │ └─ Faceting    │  │
│  │ ├─ 警報歷史           │  │ └─ 最大存活時間: 1小時 │  │ └─ 刻面         │  │
│  │ └─ elasticsearch...  │  │                      │  │                │  │
│  │ └─ elasticsearch...  │  │ Driver: pq           │  │ Client:        │  │
│  │                      │  │ 驅動程式: pq          │  │ 客戶端:         │  │
│  │ Connection Pool:     │  │ (PostgreSQL)         │  │ elastic v8     │  │
│  │ 連線池:               │  │                      │  │                │  │
│  │ ├─ Max Idle: 10      │  │                      │  │                │  │
│  │ ├─ 最大閒置: 10       │  │ Timezone:            │  │ URL:           │  │
│  │ ├─ Max Open: 100     │  │ 時區:                 │  │ URL:           │  │
│  │ ├─ 最大開啟: 100      │  │ Asia/Taipei          │  │ 10.99.1.213:9200 │
│  │ └─ Max Lifetime: 1h  │  │                      │  │                │  │
│  │ └─ 最大存活時間: 1小時 │  │ DSN: logdetect:pwd@  │  │ SSL:           │  │
│  │                      │  │ DSN: logdetect:pwd@  │  │ SSL:           │  │
│  │ Driver: MySQL        │  │      10.99.1.213/... │  │ InsecureSkip   │  │
│  │ 驅動程式: MySQL       │  │                      │  │ 跳過不安全驗證   │  │
│  │ (gorm/mysql)         │  │                      │  │                │  │
│  │                      │  │                      │  │                │  │
│  │ DSN: runner:pwd@     │  │                      │  │                │  │
│  │ DSN: runner:pwd@     │  │                      │  │                │  │
│  │      10.99.1.133/... │  │                      │  │                │  │
│  │                      │  │                      │  │                │  │
│  └──────────────────────┘  └──────────────────────┘  └───────────────┘  │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

                        ┌──────────────────────┐
                        │   Global Config      │
                        │   全域設定            │
                        ├──────────────────────┤
                        │ - EnvConfig          │
                        │ - 環境設定            │
                        │ - Mysql (GORM)       │
                        │ - TimescaleDB        │
                        │ - Elasticsearch      │
                        │ - Crontab            │
                        │ - BatchWriter        │
                        │ - 批次寫入器          │
                        └──────────────────────┘
```

---

## 資料流程圖 (Data Flow Diagrams)

### 1. 裝置監控偵測流程 (Device Monitoring Detection Flow)

```
┌─────────────────────────────┐
│   Cron Job Trigger          │
│   Cron 工作觸發              │
│   (Every N minutes/hours)   │
│   (每 N 分鐘/小時)           │
└────────────┬────────────────┘
             │
             ▼
┌─────────────────────────────┐
│  Detect() Function          │
│  偵測函式                    │
├─────────────────────────────┤
│ 1. Calculate time range     │
│ 1. 計算時間範圍              │
│ 2. Query ES for devices     │
│ 2. 查詢 ES 中的裝置          │
│    using aggregation        │
│    使用聚合                  │
│ 3. Get device list from DB  │
│ 3. 從資料庫取得裝置清單       │
└────────────┬────────────────┘
             │
      ┌──────┴──────┐
      │             │
      ▼             ▼
┌─────────────┐ ┌──────────────┐
│ ES Results  │ │ DB Devices   │
│ ES 結果     │ │ 資料庫裝置    │
└──────┬──────┘ └────────┬─────┘
       │                │
       └────────┬───────┘
                ▼
        ┌──────────────────────┐
        │  ListCompare()       │
        │  清單比對             │
        │  Detect:             │
        │  偵測:                │
        │  - Added devices     │
        │  - 新增的裝置         │
        │  - Removed devices   │
        │  - 移除的裝置         │
        │  - Intersection      │
        │  - 交集               │
        └──────────┬───────────┘
                   │
      ┌────────────┼────────────┐
      │            │            │
      ▼            ▼            ▼
  ┌────────┐  ┌────────┐  ┌──────────┐
  │ Create │  │ Store  │  │  Send    │
  │ History│  │ History│  │ Alerts   │
  │ 建立    │  │ 儲存    │  │ 發送     │
  │ 歷史紀錄│  │ 歷史紀錄│  │ 警報     │
  └───┬────┘  └──┬─────┘  └────┬─────┘
      │          │             │
      │          ▼             │
      │      ┌───────────────┐ │
      │      │   MySQL       │ │
      │      │  history      │ │
      │      │  歷史紀錄表    │ │
      │      │   table       │ │
      │      └────────┬──────┘ │
      │               │        │
      │               ▼        │
      │          ┌──────────┐  │
      │          │BatchWriter  │
      │          │批次寫入器  │  │
      │          │  Queue   │  │
      │          │  佇列     │  │
      │          └────┬─────┘  │
      │               │        │
      │        Flush (size/time)
      │        排清 (大小/時間)  │
      │               │        │
      │               ▼        │
      │          ┌──────────┐  │
      │          │TimescaleDB  │
      │          │device_metrics
      │          │裝置指標表  │  │
      │          └──────────┘  │
      │                        │
      └────────────┬───────────┘
                   │
              ┌────▼────┐
              │  SMTP   │
              │  Client │
              │ SMTP客戶端
              └────┬────┘
                   │
                   ▼
            ┌─────────────┐
            │   Email     │
            │ Notification│
            │ 電子郵件通知 │
            └─────────────┘
```

### 2. Elasticsearch 監控流程 (Elasticsearch Monitoring Flow)

```
┌────────────────────────────────┐
│  ESMonitorScheduler            │
│  ES 監控排程器                  │
│  (Per Monitor Interval)        │
│  (每個監控器間隔)                │
└────────────┬───────────────────┘
             │
             ▼
┌────────────────────────────────┐
│  MonitorESCluster()            │
│  監控 ES 叢集                   │
├────────────────────────────────┤
│ 1. Query ES /_cluster/health   │
│ 1. 查詢 ES /_cluster/health    │
│ 2. Get node stats              │
│ 2. 取得節點統計                 │
│ 3. Collect metrics:            │
│ 3. 收集指標:                    │
│    - CPU, Memory, Disk usage   │
│    - CPU、記憶體、磁碟使用量     │
│    - Response time             │
│    - 回應時間                   │
│    - Shard status              │
│    - 分片狀態                   │
└────────────┬───────────────────┘
             │
             ▼
┌────────────────────────────────┐
│  Threshold Checking            │
│  閾值檢查                       │
│  (ESAlert Logic)               │
│  (ES 警報邏輯)                  │
├────────────────────────────────┤
│ Check against:                 │
│ 檢查:                           │
│ - CPU High/Critical            │
│ - CPU 高/嚴重                   │
│ - Memory High/Critical         │
│ - 記憶體 高/嚴重                 │
│ - Disk High/Critical           │
│ - 磁碟 高/嚴重                   │
│ - Response Time High/Critical  │
│ - 回應時間 高/嚴重               │
│ - Unassigned Shards            │
│ - 未分配的分片                   │
└────────────┬───────────────────┘
             │
      ┌──────┴──────┐
      │             │
    No            Alert
   Issue        Triggered
   無問題         觸發警報
      │             │
      │             ▼
      │     ┌──────────────────┐
      │     │ Check Dedup Window
      │     │ 檢查去重視窗       │
      │     │ (Default: 5 min) │
      │     │ (預設: 5 分鐘)    │
      │     └────────┬─────────┘
      │              │
      │              ▼
      │     ┌──────────────────┐
      │     │ Store ESAlert    │
      │     │ 儲存 ES 警報      │
      │     │ to TimescaleDB   │
      │     │ 至 TimescaleDB   │
      │     │ alert_history    │
      │     │ 警報歷史表        │
      │     └────────┬─────────┘
      │              │
      │              ▼
      │     ┌──────────────────┐
      │     │  Send Notification
      │     │  發送通知         │
      │     │  (Email)         │
      │     │  (電子郵件)       │
      │     └──────────────────┘
      │
      └─────────────┬─────────────┘
                    │
                    ▼
          ┌─────────────────────┐
          │  Store ESMetric     │
          │  儲存 ES 指標        │
          │  to TimescaleDB     │
          │  至 TimescaleDB     │
          │  es_metrics table   │
          │  ES 指標表          │
          │  (via BatchWriter)  │
          │  (透過批次寫入器)    │
          └─────────────────────┘
```

### 3. 認證與授權流程 (Authentication & Authorization Flow)

```
┌──────────────────────┐
│  User Login Request  │
│  使用者登入請求        │
│  POST /auth/login    │
│  {username, password}│
│  {使用者名稱, 密碼}    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ AuthService.Login()  │
│ 認證服務.登入         │
├──────────────────────┤
│ 1. Query User from DB│
│ 1. 從資料庫查詢使用者  │
│ 2. bcrypt.Compare()  │
│ 2. bcrypt.比對       │
│    password          │
│    密碼               │
└──────────┬───────────┘
           │
      ┌────┴─────┐
      │           │
   Valid      Invalid
   Pass        Pass
   密碼正確     密碼錯誤
      │           │
      ▼           ▼
┌──────────┐  ┌──────────┐
│Generate  │  │ 401 Error│
│ JWT      │  │ 401 錯誤  │
│產生 JWT  │  │ Response │
│          │  │ 回應      │
└────┬─────┘  └──────────┘
     │
     ▼
┌──────────────────────────┐
│ JWT Token Created        │
│ JWT 令牌已建立           │
│ HS256 Signed             │
│ HS256 簽署               │
│ 24-hour expiration       │
│ 24 小時到期              │
│ Claims: user_id,         │
│ 聲明: 使用者ID,          │
│         username,        │
│         使用者名稱,       │
│         role_id,         │
│         角色ID,          │
│         exp, iat         │
│         到期時間, 簽發時間│
└────┬─────────────────────┘
     │
     ▼
┌──────────────────────┐
│ Return LoginResponse │
│ 返回登入回應          │
│ {token, user}        │
│ {令牌, 使用者}        │
└──────┬───────────────┘
       │
   [Client stores JWT in localStorage]
   [客戶端將 JWT 儲存在 localStorage]
       │
       ▼
┌──────────────────────────────┐
│ Subsequent API Request       │
│ 後續 API 請求                │
│ Authorization: Bearer {token}│
│ 授權: Bearer {令牌}          │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ AuthMiddleware checks:       │
│ 認證中介檢查:                 │
│ 1. Extract token from header │
│ 1. 從標頭提取令牌             │
│ 2. jwt.Parse()               │
│ 2. jwt.解析                  │
│ 3. Verify signature          │
│ 3. 驗證簽章                   │
│ 4. Check expiration          │
│ 4. 檢查到期時間               │
└──────────┬───────────────────┘
           │
      ┌────┴─────┐
      │           │
    Valid    Invalid/Expired
    有效      無效/已過期
     │           │
     ▼           ▼
  ┌────┐    ┌───────────┐
  │ Set│    │ 401 Abort │
  │user│    │ 401 中止   │
  │設定│    │ Request   │
  │使用│    │ 請求       │
  │者  │    └───────────┘
  │context
  │上下文
  └──┬─┘
     │
     ▼
┌──────────────────────────────┐
│ PermissionMiddleware checks: │
│ 權限中介檢查:                 │
│ 1. Get user from context     │
│ 1. 從上下文取得使用者         │
│ 2. Get user role             │
│ 2. 取得使用者角色             │
│ 3. Get role permissions      │
│ 3. 取得角色權限               │
│ 4. Check resource.action     │
│ 4. 檢查資源.動作              │
└──────────┬───────────────────┘
           │
      ┌────┴─────┐
      │           │
   Has        No
 Permission  Permission
 有權限       無權限
      │           │
      ▼           ▼
  ┌────┐    ┌───────────┐
  │Next│    │ 403 Abort │
  │Handler   │ 403 中止   │
  │下一個│    │ Request   │
  │處理器│    │ 請求       │
  └────┘    └───────────┘
```

### 4. 資料一致性與批次處理 (Data Consistency & Batch Processing)

```
┌─────────────────────────┐
│ Monitoring Results      │
│ 監控結果                 │
│ (History Entity)        │
│ (歷史紀錄實體)           │
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────┐
│ BatchWriter.AddHistory()│
│ 批次寫入器.新增歷史紀錄  │
└────────────┬────────────┘
             │
      ┌──────┴──────┐
      │             │
  Device        ES Metric
  History       (ESMetric)
  裝置歷史      ES 指標
      │             │
      ▼             ▼
┌──────────┐  ┌──────────┐
│ batch[]  │  │esBatch[] │
│ batch[]  │  │esBatch[] │
│ queue    │  │ queue    │
│ 佇列      │  │ 佇列      │
│ (max 50) │  │ (max 50) │
│ (最多50) │  │ (最多50)  │
└────┬─────┘  └────┬─────┘
     │             │
     └──────┬──────┘
            │
      ┌─────▼─────┐
      │ Flush      │
      │ 排清        │
      │ Decision   │
      │ 決策        │
      └─────┬─────┐
            │ │
       Size │ │ Timer (5s)
      大小  │ │ 計時器 (5秒)
      >=50  │ │
            │ │
            └─┴────┐
                   │
             ┌─────▼──────────┐
             │ Begin Txn      │
             │ 開始交易        │
             │ TimescaleDB    │
             └────────┬───────┘
                      │
         ┌────────────┼────────────┐
         │            │            │
         ▼            ▼            ▼
    ┌────────┐   ┌────────┐   ┌────────┐
    │Insert  │   │Insert  │   │Insert  │
    │插入    │   │插入    │   │插入    │
    │device_ │   │es_     │   │to MySQL│
    │metrics │   │metrics │   │至 MySQL│
    │裝置指標│   │ES指標  │   │history │
    │(batch) │   │(batch) │   │歷史紀錄│
    │(批次)  │   │(批次)  │   │        │
    └───┬────┘   └───┬────┘   └───┬────┘
        │            │            │
        └────────────┼────────────┘
                     │
                     ▼
         ┌──────────────────────┐
         │ Commit Transaction   │
         │ 提交交易              │
         │ (atomic)             │
         │ (原子性)              │
         └──────────┬───────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
      Commit              Rollback (error)
      提交                 回滾 (錯誤)
        │                       │
        ▼                       ▼
   ┌────────┐           ┌──────────────┐
   │ Success│           │ Retry or Log │
   │ 成功    │           │ 重試或記錄    │
   │ Log    │           │ Error        │
   │ 記錄    │           │ 錯誤          │
   └────────┘           └──────────────┘
```

---

## 組件相依性圖 (Component Dependency Graph)

```
                    main.go (Startup)
                    main.go (啟動)
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    clients/      services/      router/
    客戶端/        服務/          路由/
    └─ mysql.go   └─ sqltable.go   └─ router.go
    └─ es.go      └─ auth.go       └─ handlers
    └─ timescale  └─ detect.go     └─ 處理器
                  └─ center.go
                  └─ device.go
                  └─ target.go
                  └─ indices.go
                  └─ receiver.go
                  └─ history.go
                  └─ batch_writer.go
                  └─ es_monitor*.go
                  └─ mail.go
                  └─ dashboard.go
                  └─ tools.go
                       │
                 ┌─────┴─────┐
                 │           │
            entities/     models/
            實體/          模型/
            ├─ User        ├─ Response
            ├─ 使用者       ├─ 回應
            ├─ Role        ├─ Common
            ├─ 角色         ├─ 共用
            ├─ Permission  └─ targets.go
            ├─ 權限
            ├─ Device
            ├─ 裝置
            ├─ Target
            ├─ 目標
            ├─ Index
            ├─ 索引
            ├─ Receiver
            ├─ 接收器
            ├─ History
            ├─ 歷史紀錄
            ├─ AlertHistory
            ├─ 警報歷史
            ├─ HistoryDailyStats
            ├─ 歷史每日統計
            └─ ElasticsearchMonitor*
            └─ Elasticsearch 監控器
                     │
                     ▼
        ┌─────────────────────────┐
        │   global/global.go      │
        │   全域/global.go         │
        │                         │
        │ Global State:           │
        │ 全域狀態:                │
        │ - EnvConfig             │
        │ - 環境設定               │
        │ - Mysql (GORM)          │
        │ - TimescaleDB           │
        │ - Elasticsearch         │
        │ - Crontab              │
        │ - BatchWriter           │
        │ - 批次寫入器             │
        └─────────────────────────┘
```

---

## 設定與環境設置 (Configuration & Environment Setup)

```
┌─────────────────────────────────────┐
│  config.yml (Main Configuration)    │
│  config.yml (主要設定)               │
├─────────────────────────────────────┤
│  database:                          │
│  資料庫:                             │
│    - MySQL connection details       │
│    - MySQL 連線詳細資訊              │
│    - Connection pooling settings    │
│    - 連線池設定                      │
│                                     │
│  timescale:                         │
│    - PostgreSQL/TimescaleDB details │
│    - PostgreSQL/TimescaleDB 詳細資訊│
│    - Batch write settings           │
│    - 批次寫入設定                    │
│                                     │
│  batch_writer:                      │
│  批次寫入器:                         │
│    - Enabled: true/false            │
│    - 啟用: true/false               │
│    - Batch size: 50                 │
│    - 批次大小: 50                    │
│    - Flush interval: 5s             │
│    - 排清間隔: 5秒                   │
│                                     │
│  es:                                │
│    - Elasticsearch URL              │
│    - Elasticsearch URL              │
│    - Authentication credentials     │
│    - 認證憑證                        │
│                                     │
│  email:                             │
│  電子郵件:                           │
│    - SMTP configuration             │
│    - SMTP 設定                      │
│    - Gmail settings                 │
│    - Gmail 設定                     │
│                                     │
│  server:                            │
│  伺服器:                             │
│    - Port: 8006                     │
│    - 埠號: 8006                     │
│    - Mode: debug/release            │
│    - 模式: 除錯/發布                 │
│                                     │
│  sso:                               │
│    - Keycloak integration (optional)│
│    - Keycloak 整合 (可選)           │
│                                     │
│  cors:                              │
│    - Allow origins                  │
│    - 允許來源                        │
│    - Headers configuration          │
│    - 標頭設定                        │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  setting.yml (Monitoring Config)    │
│  setting.yml (監控設定)              │
├─────────────────────────────────────┤
│  targets:                           │
│  目標:                               │
│    - Receiver email lists           │
│    - 接收器電子郵件清單               │
│    - Subject line templates         │
│    - 主旨範本                        │
│    - Indices:                       │
│    - 索引:                           │
│      - Index pattern                │
│      - 索引模式                      │
│      - Logname                      │
│      - 日誌名稱                      │
│      - Period (minutes/hours)       │
│      - 週期 (分鐘/小時)              │
│      - Unit (frequency)             │
│      - 單位 (頻率)                   │
│      - Field (aggregation field)    │
│      - 欄位 (聚合欄位)               │
└─────────────────────────────────────┘
```

---

## 請求/回應流程範例 (Request/Response Flow Example)

### 建立監控目標 (Create Monitoring Target)

```
HTTP REQUEST
HTTP 請求
POST /api/v1/Target/Create
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "subject": "Production WebServer",
  "to": ["admin@company.com"],
  "enable": true,
  "indices": [
    {
      "id": 1,
      "pattern": "logstash-prod-*",
      "logname": "webserver",
      "period": "minutes",
      "unit": 5,
      "field": "host.keyword"
    }
  ]
}

↓ router/router.go routes to controller
↓ router/router.go 路由至控制器
↓ middleware/auth.go validates JWT
↓ middleware/auth.go 驗證 JWT
↓ middleware/auth.go validates permission (target.create)
↓ middleware/auth.go 驗證權限 (target.create)
↓ controller/target.go → CreateTarget handler
↓ controller/target.go → CreateTarget 處理器

HTTP RESPONSE (201 Created)
HTTP 回應 (201 已建立)
{
  "id": 42,
  "subject": "Production WebServer",
  "to": ["admin@company.com"],
  "enable": true,
  "indices": [...],
  "created_at": 1698650000,
  "updated_at": 1698650000
}

SIDE EFFECTS:
副作用:
1. MySQL: Insert into targets table
1. MySQL: 插入至 targets 表
2. MySQL: Insert into indices_targets table
2. MySQL: 插入至 indices_targets 表
3. Crontab: Register cron job "*/5 * * * *"
3. Crontab: 註冊 cron 工作 "*/5 * * * *"
4. MySQL: Insert into cron_lists table with entry_id
4. MySQL: 插入至 cron_lists 表並帶有 entry_id
5. Services: Start detect() execution on schedule
5. Services: 按排程啟動 detect() 執行
```

---

## 部署架構 (Deployment Architecture)

```
┌─────────────────────────────────────────────────────────┐
│                   Production Environment                │
│                   生產環境                                │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  Go Application (log-detect-backend)           │    │
│  │  Go 應用程式 (log-detect-backend)               │    │
│  │  ├─ Binary: main                               │    │
│  │  ├─ 執行檔: main                                │    │
│  │  ├─ Listening on: 0.0.0.0:8006                │    │
│  │  ├─ 監聽於: 0.0.0.0:8006                       │    │
│  │  ├─ Running services:                          │    │
│  │  ├─ 執行中的服務:                               │    │
│  │  │  - Gin HTTP Server                          │    │
│  │  │  - Gin HTTP 伺服器                          │    │
│  │  │  - Cron Job Scheduler                       │    │
│  │  │  - Cron 工作排程器                          │    │
│  │  │  - ES Monitor Scheduler                     │    │
│  │  │  - ES 監控排程器                            │    │
│  │  │  - Batch Writer Service                     │    │
│  │  │  - 批次寫入器服務                            │    │
│  │  └─ Config files:                              │    │
│  │  └─ 設定檔:                                     │    │
│  │     - config.yml                               │    │
│  │     - setting.yml                              │    │
│  └────────────────────────────────────────────────┘    │
│         │                    │                │         │
│         ▼                    ▼                ▼         │
│  ┌─────────────┐     ┌─────────────┐  ┌──────────┐   │
│  │   MySQL     │     │TimescaleDB  │  │ ES       │   │
│  │  logdetect  │     │ monitoring  │  │ cluster  │   │
│  │             │     │             │  │ 叢集      │   │
│  │ Config +    │     │ Metrics +   │  │ Logs +   │   │
│  │ 設定 +      │     │ 指標 +      │  │ 日誌 +    │   │
│  │ History     │     │ Alerts      │  │ Events   │   │
│  │ 歷史紀錄     │     │ 警報        │  │ 事件      │   │
│  └─────────────┘     └─────────────┘  └──────────┘   │
│       │                    │                │         │
└───────┼────────────────────┼────────────────┼─────────┘
        │                    │                │
        └────────────────────┼────────────────┘
                             │
                    ┌────────▼────────┐
                    │  SMTP Gateway   │
                    │  SMTP 閘道      │
                    │  (Gmail/Custom) │
                    │  (Gmail/自訂)   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  Email Clients  │
                    │  電子郵件客戶端  │
                    └─────────────────┘
```
