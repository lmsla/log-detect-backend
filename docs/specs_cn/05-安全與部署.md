# Log Detect Backend - 安全與部署指南

## 文件資訊

| 項目   | 內容                   |
| ---- | -------------------- |
| 文件版本 | 2.0                  |
| 最後更新 | 2025-11-18           |
| 文件類型 | 軟體設計文件 (SDD) - 安全與部署 |

---

## 第一部分：安全設計

## 1. 安全架構概覽

### 1.1 安全層級

```
┌─────────────────────────────────────────────┐
│          網路層安全                          │
│  - HTTPS/TLS                                │
│  - 防火牆規則                                │
│  - IP 白名單                                 │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│          應用層安全                          │
│  - JWT 認證                                 │
│  - RBAC 授權                                │
│  - CORS 設定                                │
│  - 輸入驗證                                  │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│          資料層安全                          │
│  - 密碼加密（bcrypt）                        │
│  - 資料庫連線加密                             │
│  - SQL 注入防護                              │
│  - 敏感資料遮罩                              │
└─────────────────────────────────────────────┘
```

---

## 2. 身份認證

### 2.1 JWT 令牌機制

#### 令牌結構

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": 1,
    "username": "admin",
    "role_id": 1,
    "iat": 1609459200,
    "exp": 1609545600
  },
  "signature": "..."
}
```

#### 安全配置

**JWT 密鑰管理**：

```bash
# ❌ 錯誤：使用預設密鑰
JWT_SECRET="your-secret-key-change-in-production"

# ✅ 正確：使用強密鑰
JWT_SECRET=$(openssl rand -base64 64)
```

**環境變數設定**：

```bash
# .env 檔案（不應提交至 Git）
JWT_SECRET=your-generated-secret-key-here
JWT_EXPIRATION=24h
```

#### 令牌刷新機制

建議實作 Refresh Token 機制：

1. Access Token：短期有效（1-2 小時）
2. Refresh Token：長期有效（7-30 天）
3. Refresh Token 儲存於 HttpOnly Cookie 或資料庫

### 2.2 密碼安全

#### 密碼雜湊

```go
// 使用 bcrypt，cost = 10
hashedPassword, _ := bcrypt.GenerateFromPassword([]byte(password), 10)
```

#### 密碼原則

| 原則   | 要求             |
| ---- | -------------- |
| 最小長度 | 8 個字元          |
| 複雜度  | 包含大小寫、數字、特殊字元  |
| 歷史檢查 | 不得重複使用最近 3 次密碼 |
| 過期時間 | 90 天（建議）       |

---

## 3. 授權與權限控制

### 3.1 RBAC 模型

#### 權限矩陣範例

| 資源 / 角色         | admin | operator | user |
| --------------- | ----- | -------- | ---- |
| user.*          | ✅     | ❌        | ❌    |
| target.create   | ✅     | ✅        | ❌    |
| target.read     | ✅     | ✅        | ✅    |
| target.update   | ✅     | ✅        | ❌    |
| target.delete   | ✅     | ❌        | ❌    |
| device.*        | ✅     | ✅        | ❌    |
| elasticsearch.* | ✅     | ✅        | ❌    |

### 3.2 最小權限原則

建立新使用者時：

1. 預設為 `user` 角色（唯讀）
2. 依需求逐步授予更高權限
3. 定期審查權限（每季）

### 3.3 中介軟體鏈

```
請求 → AuthMiddleware (驗證 JWT)
    → PermissionMiddleware (檢查權限)
    → Controller (業務邏輯)
```

---

## 4. 資料安全

### 4.1 敏感資料處理

#### 資料分類

| 等級  | 類型   | 範例            | 處理方式        |
| --- | ---- | ------------- | ----------- |
| 高敏感 | 認證資訊 | 密碼、JWT Secret | 加密儲存、嚴格存取控制 |
| 中敏感 | 個人資訊 | Email、姓名      | 存取記錄、資料遮罩   |
| 低敏感 | 系統資料 | 裝置名稱          | 一般保護        |

#### 密碼儲存規則

```
✅ DO：
- 使用 bcrypt 雜湊
- Salt 自動產生
- Cost factor >= 10

❌ DON'T：
- 明文儲存
- 使用 MD5 或 SHA1
- 可逆加密
```

### 4.2 資料庫連線安全

#### MySQL 連線

```yaml
database:
  host: "localhost"
  user: "logdetect_user"  # 非 root 使用者
  password: "${DB_PASSWORD}"  # 環境變數
  ssl_mode: "required"  # 強制 SSL
```

#### Elasticsearch 連線

```yaml
es:
  url: "https://es-cluster:9200"
  username: "${ES_USER}"
  password: "${ES_PASSWORD}"
  ssl_verify: true  # ⚠️ 生產環境必須啟用
```

### 4.3 TLS/SSL 安全

#### 4.3.1 當前實作（開發/測試環境）

**連線加密設定**：

目前系統支援 HTTPS 連線至 Elasticsearch，採用以下配置：

```go
// services/es_monitor.go
client: &http.Client{
    Transport: &http.Transport{
        TLSClientConfig: &tls.Config{
            InsecureSkipVerify: true, // 跳過憑證驗證
        },
    },
}
```

**資料庫欄位**（`es_connections` 表）：

| 欄位名稱          | 類型           | 說明                              |
| ------------- | ------------ | ------------------------------- |
| `use_tls`     | TINYINT(1)   | 是否使用 HTTPS 協議 (1=https, 0=http) |
| `enable_auth` | TINYINT(1)   | 是否啟用帳號密碼認證                      |
| `username`    | VARCHAR(100) | 認證使用者名稱                         |
| `password`    | VARCHAR(255) | 認證密碼                            |

**適用情境**：

- ✅ 內網環境
- ✅ 自簽憑證（Self-Signed Certificate）
- ✅ 開發/測試環境
- ⚠️ 資料傳輸已加密，但無法驗證伺服器身份
- ⚠️ 存在中間人攻擊（MITM）風險

**前端 UI 配置**：

```
[ ] 使用 TLS/HTTPS
說明: 啟用加密連線 (開發環境會跳過憑證驗證)
```

#### 4.3.2 未來增強（正式環境規劃）

> **追蹤問題**：Issue #32（🟢 低優先級）
> **預計版本**：v2.0
> **關聯文件**：[04-資料庫設計.md - 未來擴充規劃](#64-es-連線-tls-憑證驗證支援)

**規劃功能**：

##### 1. 完整憑證驗證

支援標準 TLS 憑證驗證機制：

```go
// 未來實作範例
tlsConfig := &tls.Config{
    InsecureSkipVerify: !conn.VerifyCertificate, // 可配置是否驗證
}

// 如果啟用憑證驗證且提供 CA 憑證
if conn.VerifyCertificate && conn.CACertPath != "" {
    caCert, err := os.ReadFile(conn.CACertPath)
    if err != nil {
        log.Error("Failed to read CA cert: %v", err)
    } else {
        caCertPool := x509.NewCertPool()
        caCertPool.AppendCertsFromPEM(caCert)
        tlsConfig.RootCAs = caCertPool
    }
}
```

**優點**：

- ✅ 驗證伺服器身份
- ✅ 防止中間人攻擊
- ✅ 符合企業安全標準

##### 2. 雙向 TLS (mTLS)（選配）

支援客戶端憑證認證，提供更高安全等級：

```go
// 客戶端憑證配置
if conn.ClientCertPath != "" && conn.ClientKeyPath != "" {
    cert, err := tls.LoadX509KeyPair(conn.ClientCertPath, conn.ClientKeyPath)
    if err != nil {
        log.Error("Failed to load client cert: %v", err)
    } else {
        tlsConfig.Certificates = []tls.Certificate{cert}
    }
}
```

**優點**：

- ✅ 雙向身份驗證
- ✅ 最高安全等級
- ✅ 適用於高安全性要求環境

##### 3. 資料庫擴充

需新增以下欄位至 `es_connections` 表：

| 欄位名稱                 | 類型           | 預設值  | 說明            |
| -------------------- | ------------ | ---- | ------------- |
| `verify_certificate` | TINYINT(1)   | 0    | 是否驗證 TLS 憑證   |
| `ca_cert_path`       | VARCHAR(500) | NULL | CA 憑證檔案路徑     |
| `client_cert_path`   | VARCHAR(500) | NULL | 客戶端憑證路徑（mTLS） |
| `client_key_path`    | VARCHAR(500) | NULL | 客戶端私鑰路徑（mTLS） |

**Migration 腳本**：

```sql
-- migrations/mysql/xxx_add_tls_verification.up.sql
ALTER TABLE es_connections
ADD COLUMN verify_certificate TINYINT(1) DEFAULT 0 COMMENT '是否驗證 TLS 憑證',
ADD COLUMN ca_cert_path VARCHAR(500) COMMENT 'CA 憑證檔案路徑',
ADD COLUMN client_cert_path VARCHAR(500) COMMENT '客戶端憑證路徑（mTLS）',
ADD COLUMN client_key_path VARCHAR(500) COMMENT '客戶端私鑰路徑（mTLS）';
```

##### 4. 前端 UI 設計

```
┌─────────────────────────────────────────────┐
│ ES 連線設定                                  │
├─────────────────────────────────────────────┤
│                                             │
│ ┌─ 安全設定 ────────────────────────────┐   │
│ │                                       │   │
│ │ ☑ 使用 TLS/HTTPS                      │   │
│ │   說明: 使用加密連線                    │   │
│ │                                       │   │
│ │ 憑證驗證設定:                          │   │
│ │   ○ 跳過驗證（開發環境，不安全）          │   │
│ │   ● 驗證伺服器憑證（正式環境建議）        │   │
│ │                                       │   │
│ │   [已啟用時顯示以下選項]               │   │
│ │   CA 憑證路徑: [/path/to/ca.crt    ] 📁│   │
│ │   說明: 用於驗證伺服器憑證的根憑證       │   │
│ │                                       │   │
│ │   [進階] 雙向 TLS (mTLS)              │   │
│ │   ☐ 啟用客戶端憑證驗證                 │   │
│ │      客戶端憑證: [/path/to/client.crt] 📁│   │
│ │      客戶端私鑰: [/path/to/client.key] 📁│   │
│ │                                       │   │
│ └───────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

##### 5. 配置情境對照

| 情境               | use_tls | verify_certificate | ca_cert_path                   | 說明           |
| ---------------- | ------- | ------------------ | ------------------------------ | ------------ |
| **開發環境（目前）**     | ✅ true  | ❌ false            | -                              | HTTPS + 跳過驗證 |
| **測試環境**         | ✅ true  | ❌ false            | -                              | 同開發環境        |
| **正式環境（標準）**     | ✅ true  | ✅ true             | /path/to/ca.crt                | HTTPS + 驗證憑證 |
| **正式環境（雙向 TLS）** | ✅ true  | ✅ true             | /path/to/ca.crt + client certs | 完整 mTLS      |
| **內網 HTTP**      | ❌ false | ❌ false            | -                              | HTTP 明文（不建議） |

##### 6. 實作步驟建議

1. **Phase 1：資料庫擴充**
   
   - 新增欄位至 `es_connections` 表
   - 更新 Entity 結構（`entities/es_connection.go`）
   - 測試向後相容性

2. **Phase 2：後端支援**
   
   - 修改 `NewESMonitorService()` 支援動態 TLS 配置
   - 實作憑證載入邏輯
   - 錯誤處理與日誌記錄

3. **Phase 3：前端 UI**
   
   - ES 連線設定頁面增加憑證選項
   - 檔案上傳或路徑輸入介面
   - 連線測試功能

4. **Phase 4：文件與測試**
   
   - 更新使用者手冊
   - 撰寫憑證配置指南
   - 整合測試與安全掃描

##### 7. 安全注意事項

**憑證管理**：

- 使用安全的檔案權限（600 或 400）
- 定期輪換憑證（建議每年）
- 使用環境變數或 secrets 管理工具儲存路徑

**錯誤處理**：

- 憑證驗證失敗時記錄詳細錯誤
- 提供清晰的使用者提示
- 避免洩漏敏感資訊

**向後相容**：

- `verify_certificate` 預設為 0（保持現有行為）
- 現有連線配置無需修改
- 逐步遷移至憑證驗證

---

## 5. API 安全

### 5.1 CORS 設定

```go
// 正確的 CORS 設定
cors.Config{
    AllowOrigins: []string{
        "https://app.yourdomain.com",  // 正式環境
        "http://localhost:4200"        // 開發環境
    },
    AllowMethods: []string{"GET", "POST", "PUT", "DELETE"},
    AllowHeaders: []string{"Content-Type", "Authorization"},
    AllowCredentials: true,
    MaxAge: 12 * time.Hour,
}
```

### 5.2 輸入驗證

#### 驗證規則範例

```go
type CreateTargetRequest struct {
    Subject string   `json:"subject" binding:"required,min=1,max=255"`
    To      []string `json:"to" binding:"required,dive,email"`
    Enable  bool     `json:"enable"`
    Indices []int    `json:"indices" binding:"required,min=1,dive,gt=0"`
}
```

### 5.3 速率限制（建議實作）

```go
// 使用 gin 中介軟體
import "github.com/ulule/limiter/v3"

// 每分鐘 60 次請求
rate := limiter.Rate{
    Period: 1 * time.Minute,
    Limit:  60,
}
```

### 5.4 安全 Headers

```go
// 設定安全 Headers
router.Use(func(c *gin.Context) {
    c.Header("X-Content-Type-Options", "nosniff")
    c.Header("X-Frame-Options", "DENY")
    c.Header("X-XSS-Protection", "1; mode=block")
    c.Header("Strict-Transport-Security", "max-age=31536000")
    c.Next()
})
```

---

## 6. 漏洞防護

### 6.1 SQL 注入防護

```go
// ✅ 正確：使用 ORM 參數化查詢
db.Where("username = ?", username).First(&user)

// ❌ 錯誤：字串拼接
db.Raw("SELECT * FROM users WHERE username = '" + username + "'")
```

### 6.2 XSS 防護

- 前端：使用框架內建的 HTML 轉義
- 後端：驗證並清理使用者輸入
- 回應：設定 `Content-Type: application/json`

### 6.3 CSRF 防護

對於狀態變更操作（POST, PUT, DELETE）：

- 使用 CSRF Token
- 或依賴 JWT（如果儲存於 Header 而非 Cookie）

---

## 第二部分：部署指南

## 7. 部署架構

### 7.1 生產環境架構

```
                    Internet
                        │
                   ┌────▼────┐
                   │ Nginx   │ (HTTPS, 反向代理)
                   │ (80/443)│
                   └────┬────┘
                        │
         ┌──────────────┼──────────────┐
         │              │              │
    ┌────▼────┐    ┌───▼────┐    ┌───▼────┐
    │  App 1  │    │  App 2 │    │  App 3 │ (負載平衡)
    │  :8006  │    │  :8006 │    │  :8006 │
    └────┬────┘    └───┬────┘    └───┬────┘
         │             │              │
         └─────────────┼──────────────┘
                       │
         ┌─────────────┼──────────────┐
         │             │              │
    ┌────▼────┐   ┌───▼─────┐   ┌───▼────────┐
    │  MySQL  │   │TimescaleDB  │Elasticsearch│
    │  :3306  │   │  :5432   │   │   :9200    │
    └─────────┘   └──────────┘   └────────────┘
```

### 7.2 系統需求

#### 最低配置（測試環境）

- CPU: 2 Core
- RAM: 4 GB
- 硬碟: 50 GB SSD
- OS: Ubuntu 20.04+ / CentOS 7+

#### 建議配置（生產環境）

- CPU: 4-8 Core
- RAM: 16-32 GB
- 硬碟: 500 GB SSD（依資料量調整）
- OS: Ubuntu 22.04 LTS

---

## 8. 部署步驟

### 8.1 環境準備

#### 安裝 Go

```bash
wget https://go.dev/dl/go1.24.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.24.0.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
```

#### 安裝資料庫

```bash
# MySQL
sudo apt install mysql-server

# TimescaleDB
sudo apt install postgresql-14 timescaledb-2-postgresql-14

# Elasticsearch（Docker 部署）
docker run -d -p 9200:9200 -e "discovery.type=single-node" \
  elasticsearch:8.0.0
```

### 8.2 應用程式部署

#### 編譯

```bash
# 開發版本
go build -o log-detect-backend main.go

# 生產版本（減少大小、去除除錯資訊）
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
  go build -ldflags="-s -w" -o log-detect-backend main.go
```

#### 配置檔設定

```yaml
# config.yml
server:
  port: ":8006"
  mode: "release"  # 生產模式

database:
  host: "db-server"
  port: "3306"
  user: "${MYSQL_USER}"
  password: "${MYSQL_PASSWORD}"
  name: "logdetect"

# ... 其他配置
```

#### 環境變數

```bash
# /etc/environment 或使用 systemd EnvironmentFile
export MYSQL_USER=logdetect_user
export MYSQL_PASSWORD=secure_password
export JWT_SECRET=your_generated_secret
export GIN_MODE=release
```

### 8.3 Systemd 服務設定

```ini
# /etc/systemd/system/log-detect-backend.service
[Unit]
Description=Log Detect Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=logdetect
WorkingDirectory=/opt/log-detect-backend
ExecStart=/opt/log-detect-backend/log-detect-backend
Restart=on-failure
RestartSec=5s

# 環境變數
EnvironmentFile=/etc/log-detect-backend/.env

# 安全加固
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/log-detect-backend/log

[Install]
WantedBy=multi-user.target
```

**啟動服務**：

```bash
sudo systemctl daemon-reload
sudo systemctl enable log-detect-backend
sudo systemctl start log-detect-backend
sudo systemctl status log-detect-backend
```

### 8.4 Nginx 反向代理

```nginx
# /etc/nginx/sites-available/log-detect-backend
upstream backend {
    server 127.0.0.1:8006;
    # 負載平衡（如有多個實例）
    # server 127.0.0.1:8007;
    # server 127.0.0.1:8008;
}

server {
    listen 80;
    server_name api.yourdomain.com;

    # HTTP 轉 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    # SSL 憑證
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;

    # SSL 安全設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 安全 Headers
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # 反向代理
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超時設定
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 限制請求大小
    client_max_body_size 10M;
}
```

---

## 9. 監控與維運

### 9.1 日誌管理

#### 應用程式日誌

```
/opt/log-detect-backend/log/
├── LogDetect-202511.log
├── apiError-202511.log
└── ...
```

#### 日誌輪轉

```ini
# /etc/logrotate.d/log-detect-backend
/opt/log-detect-backend/log/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 logdetect logdetect
}
```

### 9.2 健康檢查

```bash
# 基本健康檢查
curl http://localhost:8006/healthcheck

# 詳細檢查（包含資料庫連線）
curl http://localhost:8006/api/v1/health/detailed
```

### 9.3 監控指標

#### 系統指標

- CPU 使用率
- 記憶體使用率
- 磁碟 I/O
- 網路流量

#### 應用指標

- API 請求速率（QPS）
- API 回應時間（P50, P95, P99）
- 錯誤率
- 資料庫連線數

#### 業務指標

- 監控目標數量
- 監控裝置數量
- 警報數量（按嚴重程度）
- 批次寫入延遲

### 9.4 告警規則

| 指標       | 閾值    | 級別       | 通知管道        |
| -------- | ----- | -------- | ----------- |
| API 錯誤率  | > 5%  | Critical | Email + SMS |
| 回應時間 P95 | > 1秒  | Warning  | Email       |
| CPU 使用率  | > 80% | Warning  | Email       |
| 磁碟使用率    | > 85% | Critical | Email + SMS |
| 資料庫連線數   | > 80  | Warning  | Email       |

---

## 10. 備份與災難復原

### 10.1 備份策略

#### 資料庫備份

```bash
#!/bin/bash
# 每日備份腳本

BACKUP_DIR="/backup/logdetect"
DATE=$(date +%Y%m%d)

# MySQL 備份
mysqldump -u backup_user -p${MYSQL_PASSWORD} logdetect \
  | gzip > ${BACKUP_DIR}/mysql_${DATE}.sql.gz

# TimescaleDB 備份
pg_dump -U postgres -d monitoring -Fc \
  > ${BACKUP_DIR}/timescale_${DATE}.dump

# 刪除 30 天前的備份
find ${BACKUP_DIR} -name "*.gz" -mtime +30 -delete
find ${BACKUP_DIR} -name "*.dump" -mtime +30 -delete
```

#### 配置檔備份

```bash
# 備份配置檔與應用程式
tar -czf /backup/app_config_${DATE}.tar.gz \
  /opt/log-detect-backend/config.yml \
  /opt/log-detect-backend/setting.yml \
  /etc/systemd/system/log-detect-backend.service
```

### 10.2 災難復原計畫

#### RTO（復原時間目標）：4 小時

#### RPO（復原點目標）：24 小時

**復原步驟**：

1. 準備新伺服器
2. 安裝相依套件（1 小時）
3. 復原資料庫（2 小時）
4. 部署應用程式（30 分鐘）
5. 驗證功能（30 分鐘）

---

## 11. 安全檢查清單

### 11.1 部署前檢查

- [ ] JWT Secret 已變更為強密鑰
- [ ] 資料庫密碼使用強密碼
- [ ] 已啟用 HTTPS/TLS
- [ ] Elasticsearch SSL 驗證已啟用
- [ ] 防火牆規則已設定
- [ ] 預設管理員密碼已變更
- [ ] 不必要的資料庫使用者已刪除
- [ ] 已設定速率限制
- [ ] 已設定輸入驗證
- [ ] 敏感配置檔權限設為 600

### 11.2 定期檢查（每季）

- [ ] 更新套件與安全補丁
- [ ] 審查使用者權限
- [ ] 檢查異常登入記錄
- [ ] 驗證備份可用性
- [ ] 測試災難復原流程
- [ ] 審查安全日誌
- [ ] 執行滲透測試

---

## 12. 疑難排解

### 12.1 常見問題

#### 問題：無法連線資料庫

```bash
# 檢查資料庫服務狀態
sudo systemctl status mysql
sudo systemctl status postgresql

# 檢查網路連線
telnet db-server 3306
telnet db-server 5432

# 檢查防火牆
sudo ufw status
```

#### 問題：JWT 驗證失敗

```bash
# 檢查 JWT Secret 是否一致
echo $JWT_SECRET

# 檢查令牌是否過期
# 使用 jwt.io 解碼令牌並查看 exp 欄位
```

#### 問題：記憶體不足

```bash
# 查看記憶體使用
free -h
top

# 調整 Go GC 行為
export GOGC=50  # 更激進的 GC（預設 100）
```

---

**文件結束**
