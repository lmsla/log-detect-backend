# 06 - å¾…ä¿®å¾©å•é¡Œæ¸…å–®

> ç”¢ç”Ÿæ—¥æœŸï¼š2024-11-24
> æª¢æŸ¥ç¯„åœï¼šå…¨å°ˆæ¡ˆç¨‹å¼ç¢¼å¯©æŸ¥

---

## å•é¡Œçµ±è¨ˆ

| å„ªå…ˆç´š    | æ•¸é‡     | èªªæ˜                   |
| ------ | ------ | -------------------- |
| ğŸ”´ é«˜   | 16     | å¿…é ˆç«‹å³ä¿®å¾©ï¼Œå¯èƒ½å°è‡´ç¨‹å¼å´©æ½°æˆ–è³‡æ–™éŒ¯èª¤ |
| ğŸŸ¡ ä¸­   | 13     | æ‡‰ç›¡å¿«ä¿®å¾©ï¼Œå½±éŸ¿æ•ˆèƒ½æˆ–ç¶­è­·æ€§       |
| ğŸŸ¢ ä½   | 5      | å¯æ”¹é€²é …ç›®ï¼Œæœ€ä½³å¯¦è¸å»ºè­°         |
| **ç¸½è¨ˆ** | **34** |                      |

---

## ğŸ”´ é«˜å„ªå…ˆç´š - å¿…é ˆç«‹å³ä¿®å¾©

### 1. ES é€£ç·šç›¸é—œ

| #   | æª”æ¡ˆ                                  | è¡Œè™Ÿ      | å•é¡Œæè¿°                                                  | å½±éŸ¿                          |
| --- | ----------------------------------- | ------- | ----------------------------------------------------- | --------------------------- |
| 1   | `services/es_monitor_query.go`      | 169     | ç›´æ¥ä½¿ç”¨ `monitor.ESConnection.Host` è€Œæœªç¶“ `CleanHost()` è™•ç† | è‹¥ Host å«å”è­°å‰ç¶´ï¼Œé¡¯ç¤ºçš„ host è³‡è¨ŠæœƒéŒ¯èª¤ |
| 2   | `services/es_connection_service.go` | 127-134 | `UpdateESConnection` ç¦ç”¨èªè­‰æ™‚æœªæ¸…é™¤ Username/Password       | æ•æ„Ÿè³‡è¨Šæ®˜ç•™ï¼Œå®‰å…¨é¢¨éšª                 |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 1ï¼šes_monitor_query.go:169
// ä¿®æ”¹å‰
host = fmt.Sprintf("%s:%d", monitor.ESConnection.Host, monitor.ESConnection.Port)
// ä¿®æ”¹å¾Œ
host = fmt.Sprintf("%s:%d", monitor.ESConnection.CleanHost(), monitor.ESConnection.Port)

// å•é¡Œ 2ï¼šes_connection_service.go
// åœ¨ UpdateESConnection ä¸­æ·»åŠ 
if !connection.EnableAuth {
    connection.Username = ""
    connection.Password = ""
}
```

---

### 2. BatchWriter / TimescaleDB

| #   | æª”æ¡ˆ                         | è¡Œè™Ÿ       | å•é¡Œæè¿°                               | å½±éŸ¿                                                                                |
| --- | -------------------------- | -------- | ---------------------------------- | --------------------------------------------------------------------------------- |
| 3   | `services/batch_writer.go` | 74-88    | `esStmt` æœªè¢«é—œé–‰ï¼Œåªé—œé–‰äº† `stmt`          | è³‡æºæ´©æ¼ï¼Œé•·æœŸé‹è¡Œæœƒè€—ç›¡é€£ç·šæ±                                                                    |
| 4   | `services/detect.go`       | 172, 213 | `global.BatchWriter` æœªæª¢æŸ¥ nil å°±èª¿ç”¨   | è‹¥ BatchWriter æœªå•Ÿç”¨æœƒ panic                                                          |
| 5   | `services/batch_writer.go` | 136      | `device_metrics` çš„ `stmt` ç„¡ nil æª¢æŸ¥ | è‹¥ prepare å¤±æ•—æœƒ panic                                                               |
| 6   | `services/es_monitor.go`   | 745-763  | `es_alert_history` INSERT ç¼ºå°‘ 5 å€‹æ¬„ä½ | è³‡æ–™ä¸å®Œæ•´ï¼šresolved_at, resolved_by, resolution_note, acknowledged_at, acknowledged_by |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 3ï¼šbatch_writer.go:74-88
case <-bw.stopChan:
    bw.flushBatch()
    if bw.stmt != nil {
        bw.stmt.Close()
    }
    if bw.esStmt != nil {  // æ–°å¢
        bw.esStmt.Close()
    }
    return

// å•é¡Œ 4ï¼šdetect.go:172, 213
if global.BatchWriter != nil {
    if err := global.BatchWriter.AddHistory(historyData); err != nil {
        log.Logrecord_no_rotate("ERROR", ...)
    }
}

// å•é¡Œ 5ï¼šbatch_writer.go:136
func (bw *BatchWriter) flushDeviceMetrics() {
    if len(bw.batch) == 0 {
        return
    }
    if bw.stmt == nil {  // æ–°å¢
        log.Logrecord_no_rotate("ERROR", "Device metrics prepared statement is nil, skipping flush")
        bw.batch = bw.batch[:0]
        return
    }
    // ...
}

// å•é¡Œ 6ï¼šes_monitor.go INSERT èªå¥éœ€è£œå®Œ
INSERT INTO es_alert_history (
    time, monitor_id, alert_type, severity, status, message,
    cluster_name, threshold_value, actual_value,
    resolved_at, resolved_by, resolution_note,      -- æ–°å¢
    acknowledged_at, acknowledged_by,                -- æ–°å¢
    metadata
) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15)
```

---

### 3. éŒ¯èª¤è™•ç†

| #   | æª”æ¡ˆ                   | è¡Œè™Ÿ      | å•é¡Œæè¿°                            | å½±éŸ¿                  |
| --- | -------------------- | ------- | ------------------------------- | ------------------- |
| 7   | `services/detect.go` | 117     | `rows.Scan(&id)` éŒ¯èª¤æœªè™•ç†          | è³‡æ–™å¯èƒ½æå£ä½†ä¸æœƒç”¢ç”Ÿæ—¥èªŒ       |
| 8   | `services/detect.go` | 109-118 | `device_list` æŸ¥è©¢éŒ¯èª¤å¾Œç¹¼çºŒåŸ·è¡Œ         | nil slice è¿­ä»£æœƒ panic |
| 9   | `services/mail.go`   | 195     | `smtp.Data()` éŒ¯èª¤è¢«ä¸Ÿæ£„ï¼Œæª¢æŸ¥çš„æ˜¯ä¹‹å‰çš„ err | éƒµä»¶ç™¼é€å¤±æ•—ä½†éŒ¯èª¤è¨Šæ¯èª¤å°       |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 7ï¼šdetect.go:117
for rows.Next() {
    var id int
    if err := rows.Scan(&id); err != nil {  // ä¿®æ”¹
        log.Logrecord_no_rotate("ERROR", fmt.Sprintf("Failed to scan device id: %s", err.Error()))
        continue
    }
    ids = append(ids, id)
}

// å•é¡Œ 8ï¼šdetect.go:109-118
device_list, err := GetDevicesDataByGroupName(device_group)
if err != nil {
    log.Logrecord_no_rotate("ERROR", ...)
    return  // æ–°å¢ï¼šæå‰è¿”å›
}

// å•é¡Œ 9ï¼šmail.go:195
wc, err := c.Data()  // ä¿®æ”¹ï¼šæ¥æ”¶éŒ¯èª¤
if err != nil {
    log.Printf("[Error] Failed to send email (No Auth) by Data, err:%s\n", err)
    return false
}
```

---

### 4. ä½µç™¼å•é¡Œ

| #   | æª”æ¡ˆ                         | è¡Œè™Ÿ       | å•é¡Œæè¿°                                       | å½±éŸ¿                                    |
| --- | -------------------------- | -------- | ------------------------------------------ | ------------------------------------- |
| 10  | `services/es_scheduler.go` | 132, 190 | `StopMonitor` å’Œ `StopAll` éƒ½æœƒ close channel | è‹¥åŒæ™‚èª¿ç”¨æœƒ panic: close of closed channel |
| 11  | `services/batch_writer.go` | 224      | `Stop()` å¤šæ¬¡èª¿ç”¨æœƒ close å·²é—œé–‰çš„ channel          | panic                                 |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 10, 11ï¼šä½¿ç”¨ sync.Once æˆ–ç‹€æ…‹æ¨™è¨˜
type ESMonitorJob struct {
    Monitor  entities.ElasticsearchMonitor
    Ticker   *time.Ticker
    StopChan chan bool
    stopped  bool      // æ–°å¢
    mu       sync.Mutex // æ–°å¢
}

func (j *ESMonitorJob) Stop() {
    j.mu.Lock()
    defer j.mu.Unlock()
    if !j.stopped {
        close(j.StopChan)
        j.stopped = true
    }
}
```

---

### 5. Entity/Migration ä¸ä¸€è‡´

| #   | æª”æ¡ˆ                    | è¡Œè™Ÿ  | å•é¡Œæè¿°                                             | å½±éŸ¿               |
| --- | --------------------- | --- | ------------------------------------------------ | ---------------- |
| 12  | `entities/targets.go` | 41  | `Index.Unit` GORM æ¨™ç±¤èªæ³•éŒ¯èª¤ï¼š`type:"int"`            | GORM ç„¡æ³•è­˜åˆ¥é¡å‹æ¨™ç±¤    |
| 13  | `entities/targets.go` | 247 | `MailHistory.Sended` ä½¿ç”¨ `type:boolean`ï¼ŒMySQL ä¸æ”¯æ´ | AutoMigrate å¯èƒ½å¤±æ•— |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 12ï¼štargets.go:41
// ä¿®æ”¹å‰
Unit int `type:"int" json:"unit" form:"unit"`
// ä¿®æ”¹å¾Œ
Unit int `gorm:"type:int" json:"unit" form:"unit"`

// å•é¡Œ 13ï¼štargets.go:247
// ä¿®æ”¹å‰
Sended bool `gorm:"type:boolean" json:"sended" form:"sended"`
// ä¿®æ”¹å¾Œ
Sended bool `gorm:"type:tinyint(1);default:0" json:"sended" form:"sended"`
```

---

### 6. OpenAPI æ–‡æª”éŒ¯èª¤

| #   | æª”æ¡ˆ                  | è¡Œè™Ÿ        | å•é¡Œæè¿°                                          | å½±éŸ¿              |
| --- | ------------------- | --------- | --------------------------------------------- | --------------- |
| 14  | `docs/openapi.yml`  | 1998-2185 | ES Alert è·¯ç”±åƒæ•¸éŒ¯èª¤ï¼š`{id}` æ‡‰ç‚º `{monitor_id}`      | å®¢æˆ¶ç«¯ç”Ÿæˆçš„ç¨‹å¼ç¢¼ä½¿ç”¨éŒ¯èª¤åƒæ•¸ |
| 15  | `docs/openapi.yml`  | -         | `GetESAlertByID` ç¼ºå°‘å¿…éœ€çš„ `alert_time` æŸ¥è©¢åƒæ•¸      | API æ–‡æª”ä¸å®Œæ•´       |
| 16  | `docs/swagger.yaml` | 48-108    | `ElasticsearchMonitor` æ¶æ§‹éæ™‚ï¼ˆå«èˆŠçš„ host/port æ¬„ä½ï¼‰ | æ–‡æª”èˆ‡å¯¦éš› API ä¸ç¬¦    |

---

## ğŸŸ¡ ä¸­å„ªå…ˆç´š - æ‡‰ç›¡å¿«ä¿®å¾©

### 7. N+1 æŸ¥è©¢å•é¡Œ

| #   | æª”æ¡ˆ                             | è¡Œè™Ÿ  | å•é¡Œæè¿°                                                 | å½±éŸ¿                       |
| --- | ------------------------------ | --- | ---------------------------------------------------- | ------------------------ |
| 17  | `services/es_monitor_query.go` | 174 | `GetAllMonitorsStatus` å¾ªç’°ä¸­ç‚ºæ¯å€‹ monitor æŸ¥è©¢ TimescaleDB | 100 å€‹ monitors = 101 æ¬¡æŸ¥è©¢ |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// ä½¿ç”¨å–®æ¬¡æŸ¥è©¢å–å¾—æ‰€æœ‰ monitor çš„æœ€æ–°æŒ‡æ¨™
// è€Œéåœ¨å¾ªç’°ä¸­é€å€‹æŸ¥è©¢
query := `
    SELECT DISTINCT ON (monitor_id) *
    FROM es_metrics
    WHERE monitor_id = ANY($1)
    ORDER BY monitor_id, time DESC
`
```

---

### 8. Preload éºæ¼

| #   | æª”æ¡ˆ                               | è¡Œè™Ÿ  | å•é¡Œæè¿°                            | å½±éŸ¿        |
| --- | -------------------------------- | --- | ------------------------------- | --------- |
| 18  | `services/es_monitor_service.go` | 99  | `UpdateESMonitor` é¦–æ¬¡æŸ¥è©¢æœª Preload | é¡å¤–æŸ¥è©¢ï¼Œæ•ˆèƒ½æå¤± |
| 19  | `services/es_monitor_service.go` | 220 | `ToggleESMonitor` é¦–æ¬¡æŸ¥è©¢æœª Preload | é¡å¤–æŸ¥è©¢ï¼Œæ•ˆèƒ½æå¤± |
| 20  | `services/es_monitor_service.go` | 183 | `DeleteESMonitor` æœª Preload     | ä¸€è‡´æ€§å•é¡Œ     |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// çµ±ä¸€ä½¿ç”¨ Preload
if err := global.Mysql.Preload("ESConnection").First(&monitor, id).Error; err != nil {
    // ...
}
```

---

### 9. äº‹å‹™è™•ç†

| #   | æª”æ¡ˆ                         | è¡Œè™Ÿ       | å•é¡Œæè¿°                                   | å½±éŸ¿       |
| --- | -------------------------- | -------- | -------------------------------------- | -------- |
| 21  | `services/batch_writer.go` | 134, 190 | `defer tx.Rollback()` åœ¨ Commit æˆåŠŸå¾Œä»æœƒåŸ·è¡Œ | å¯èƒ½ç”¢ç”ŸéŒ¯èª¤æ—¥èªŒ |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å‘½åè¿”å›å€¼
func (bw *BatchWriter) flushDeviceMetrics() (err error) {
    tx, err := bw.db.Begin()
    if err != nil {
        return err
    }
    defer func() {
        if err != nil {
            tx.Rollback()
        }
    }()
    // ...
    return tx.Commit()
}

// æ–¹æ¡ˆ 2ï¼šå¿½ç•¥å·²æäº¤äº‹å‹™çš„ Rollback éŒ¯èª¤ï¼ˆPostgreSQL æœƒè¿”å›éŒ¯èª¤ï¼‰
```

---

### 10. è³‡æ–™åº«æŸ¥è©¢

| #   | æª”æ¡ˆ                              | è¡Œè™Ÿ  | å•é¡Œæè¿°                | å½±éŸ¿        |
| --- | ------------------------------- | --- | ------------------- | --------- |
| 22  | `services/timescale_history.go` | å¤šè™•  | ç¼ºå°‘ `rows.Err()` æª¢æŸ¥  | è¡Œè¿­ä»£éŒ¯èª¤è¢«å¿½ç•¥  |
| 23  | `services/es_monitor_query.go`  | 304 | æ´»èºå‘Šè­¦æŸ¥è©¢éŒ¯èª¤è¢«å¿½ç•¥ï¼ˆä½¿ç”¨ `_`ï¼‰ | çµ±è¨ˆæ•¸æ“šå¯èƒ½ä¸æº–ç¢º |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 22ï¼šåœ¨æ‰€æœ‰ rows è¿­ä»£å¾Œæ·»åŠ 
for rows.Next() {
    // ...
}
if err := rows.Err(); err != nil {
    log.Logrecord_no_rotate("ERROR", fmt.Sprintf("Row iteration error: %s", err.Error()))
}

// å•é¡Œ 23ï¼šes_monitor_query.go:304
if err := s.db.QueryRow(alertQuery).Scan(&stats.ActiveAlerts); err != nil {
    log.Logrecord_no_rotate("WARN", fmt.Sprintf("Failed to get active alerts count: %s", err.Error()))
}
```

---

### 11. å¤–éµç´„æŸç¼ºå¤±

| #   | æª”æ¡ˆ                                                  | è¡Œè™Ÿ    | å•é¡Œæè¿°                                     | å½±éŸ¿            |
| --- | --------------------------------------------------- | ----- | ---------------------------------------- | ------------- |
| 24  | `migrations/mysql/001_users_and_permissions.up.sql` | -     | `User.RoleID` ç¼ºå°‘ FOREIGN KEY ç´„æŸ          | ç„¡æ³•ä¿è­‰è³‡æ–™å®Œæ•´æ€§     |
| 25  | `migrations/mysql/003_devices.up.sql`               | -     | `Index.ESConnectionID` ç¼ºå°‘ FOREIGN KEY ç´„æŸ | ç„¡æ³•ä¿è­‰è³‡æ–™å®Œæ•´æ€§     |
| 26  | `entities/elasticsearch.go`                         | 23-24 | `ESConnectionID` ç¼ºå°‘ constraint æ¨™ç±¤        | GORM ä¸æœƒè‡ªå‹•å»ºç«‹ç´„æŸ |

**ä¿®å¾©å»ºè­°ï¼š**

```go
// å•é¡Œ 26ï¼šentities/elasticsearch.go
ESConnectionID int           `gorm:"not null;index;constraint:OnUpdate:CASCADE,OnDelete:RESTRICT" json:"es_connection_id"`
ESConnection   *ESConnection `gorm:"foreignKey:ESConnectionID" json:"es_connection,omitempty"`
```

---

### 12. Module Entity å•é¡Œ

| #   | æª”æ¡ˆ                 | è¡Œè™Ÿ    | å•é¡Œæè¿°                                                  | å½±éŸ¿              |
| --- | ------------------ | ----- | ----------------------------------------------------- | --------------- |
| 27  | `entities/menu.go` | 21-28 | `Module` çš„ Name, URL, LicenseKey, Disabled ç¼ºå°‘ GORM æ¨™ç±¤ | GORM æ¨æ–·é¡å‹å¯èƒ½ä¸ç¬¦é æœŸ |

**ä¿®å¾©å»ºè­°ï¼š**

```go
type Module struct {
    models.Common
    ID         int    `json:"id" gorm:"primaryKey"`
    Name       string `json:"name" gorm:"type:varchar(100)"`
    URL        string `json:"url" gorm:"type:varchar(255)"`
    LicenseKey string `json:"-" gorm:"type:varchar(255);column:license_key"`
    Disabled   bool   `json:"disabled" gorm:"type:tinyint(1);default:0"`
}
```

---

### 13. æ–‡æª”ä¸ä¸€è‡´

| #   | æª”æ¡ˆ                  | è¡Œè™Ÿ        | å•é¡Œæè¿°                            | å½±éŸ¿    |
| --- | ------------------- | --------- | ------------------------------- | ----- |
| 28  | `docs/swagger.yaml` | 1036-1055 | åŒ…å«å·²ç§»é™¤çš„ `/monitors/{id}/test` ç«¯é» | èª¤å°é–‹ç™¼è€… |
| 29  | `docs/openapi.yml`  | -         | ç¼ºå°‘ç’°å¢ƒç«¯é»å’Œ Admin è·¯ç”±æ–‡æª”              | æ–‡æª”ä¸å®Œæ•´ |

---

## ğŸŸ¢ ä½å„ªå…ˆç´š - å¯æ”¹é€²é …ç›®

| #   | æª”æ¡ˆ                          | è¡Œè™Ÿ      | å•é¡Œæè¿°                            | å»ºè­°          |
| --- | --------------------------- | ------- | ------------------------------- | ----------- |
| 30  | `entities/es_connection.go` | 59-78   | `Validate()` ä¿®æ”¹è¼¸å…¥ç‰©ä»¶ï¼ˆc.Hostï¼‰     | è€ƒæ…®åˆ†é›¢æ¸…ç†å’Œé©—è­‰é‚è¼¯ |
| 31  | `entities/es_connection.go` | -       | Host æ¬„ä½ç¼ºå°‘ IP/åŸŸåæ ¼å¼é©—è­‰             | å¯æ·»åŠ æ­£å‰‡é©—è­‰     |
| 32  | `services/es_monitor.go`    | 29      | TLS è­‰æ›¸é©—è­‰è¢«è·³é                     | ç”Ÿç”¢ç’°å¢ƒæ‡‰å¯é…ç½®    |
| 33  | `services/es_monitor.go`    | 752-764 | `es_alert_history` æœªä½¿ç”¨æ‰¹è™•ç†       | é«˜é »å‘Šè­¦æ™‚æ•ˆèƒ½ä¸ä½³   |
| 34  | `docs/`                     | -       | åŒæ™‚ç¶­è­· swagger.yaml å’Œ openapi.yml | è€ƒæ…®åªä¿ç•™ä¸€ä»½     |

---

## ä¿®å¾©é€²åº¦è¿½è¹¤

| #   | ç‹€æ…‹    | ä¿®å¾©æ—¥æœŸ       | ä¿®å¾©è€…    | å‚™è¨»                                                                 |
| --- | ----- | ---------- | ------ | ------------------------------------------------------------------ |
| 1   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | es_monitor_query.go:169 ä½¿ç”¨ CleanHost() æ¸…ç†å”è­°å‰ç¶´                      |
| 2   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | es_connection_service.go:134-138 ç¦ç”¨èªè­‰æ™‚æ¸…é™¤å¯†ç¢¼                         |
| 3   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | batch_writer.go:86-88 æ·»åŠ  esStmt.Close() é˜²æ­¢è³‡æºæ´©æ¼                     |
| 4   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | detect.go:172,213 BatchWriter nil æª¢æŸ¥å®Œæˆ                             |
| 5   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | batch_writer.go:134-137 æ·»åŠ  stmt nil æª¢æŸ¥é˜²æ­¢ panic                     |
| 6   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | es_monitor.go:745-772 INSERT è£œé½Š 5 å€‹æ¬„ä½ (resolved_*, acknowledged_*) |
| 7   | â¬œ å¾…ä¿®å¾© |            |        |                                                                    |
| 8   | â¬œ å¾…ä¿®å¾© |            |        |                                                                    |
| 9   | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | mail.go:195 éŒ¯èª¤è®Šæ•¸ä¿®å¾©å®Œæˆ                                               |
| 10  | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | es_scheduler.go ä½¿ç”¨ sync.Once é˜²æ­¢ channel é‡è¤‡é—œé–‰                       |
| 11  | âœ… å·²å®Œæˆ | 2024-11-24 | Claude | batch_writer.go ä½¿ç”¨ sync.Once é˜²æ­¢ channel é‡è¤‡é—œé–‰                       |
| ... | â¬œ å¾…ä¿®å¾© |            |        |                                                                    |

---

## ç›¸é—œæ–‡ä»¶

- [01-ç³»çµ±æ¦‚è¿°](./01-ç³»çµ±æ¦‚è¿°.md)
- [02-æ¶æ§‹è¨­è¨ˆ](./02-æ¶æ§‹è¨­è¨ˆ.md)
- [04-è³‡æ–™åº«è¨­è¨ˆ](./04-è³‡æ–™åº«è¨­è¨ˆ.md)
