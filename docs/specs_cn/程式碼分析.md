# Log Detect Backend - 全面程式碼庫分析

## 執行摘要

**Log Detect Backend** 是一個基於 Go 語言並使用 Gin 框架建構的監控和日誌系統,整合了 Elasticsearch、MySQL 和 TimescaleDB,用於集中式日誌聚合、設備監控和異常檢測。該系統提供了一個 REST API 用於管理監控目標、設備和索引,並配備了一個全面的排程器,用於定期健康檢查和警報生成。

---

## 1. 整體架構與專案結構

### 目錄結構
```
log-detect-backend/
├── main.go                 # 應用程式入口點
├── config.yml             # 配置檔案
├── setting.yml            # 監控目標和接收者配置
├── go.mod / go.sum        # Go 依賴項
├── clients/               # 外部服務客戶端
│   ├── mysql.go           # MySQL 資料庫連線
│   ├── es.go              # Elasticsearch 客戶端
│   └── timescale.go       # TimescaleDB 連線
├── entities/              # 領域模型 (User, Role, Target, Index 等)
├── models/                # 回應和資料結構
├── services/              # 業務邏輯層 (22 個服務)
├── controller/            # HTTP 請求處理器 (9 個控制器)
├── router/                # 路由定義
├── middleware/            # 身份驗證和授權
├── global/                # 全域變數和配置狀態
├── structs/               # 配置結構
├── utils/                 # 工具函數 (CORS 配置)
├── handler/               # 錯誤處理
├── log/                   # 日誌系統
└── docs/                  # Swagger API 文件
```

### 技術堆疊
- **語言**: Go 1.24.0
- **Web 框架**: Gin-gonic (v1.9.1)
- **主要資料庫**: MySQL (GORM ORM)
- **時序資料庫**: TimescaleDB (PostgreSQL 擴充)
- **搜尋引擎**: Elasticsearch v8
- **作業排程器**: Robfig Cron v3
- **身份驗證**: JWT (golang-jwt)
- **密碼雜湊**: bcrypt
- **文件工具**: Swagger (swaggo)
- **CORS**: Gin-contrib/cors

---

## 2. 主要元件

### 2.1 客戶端層 (連線管理)

#### mysql.go
- 使用 GORM 建立 MySQL 連線
- 實作連線池和生命週期管理
- 配置:主機、埠、使用者、密碼、資料庫名稱
- 支援自動重新連線重試邏輯

#### es.go
- Elasticsearch v8 客戶端初始化
- SSL/TLS 配置,包含 InsecureSkipVerify 選項
- 支援使用者名稱/密碼認證
- 透過叢集資訊端點進行連線驗證

#### timescale.go
- 為 TimescaleDB 初始化 PostgreSQL 驅動程式
- 連線池配置
- 時區設定:Asia/Taipei
- 支援批次插入時序資料

---

### 2.2 實體 (領域模型)

#### 使用者與身份驗證實體
```go
type User struct {
  ID       uint
  Username string (unique index)
  Email    string (unique index)
  Password string (bcrypt hashed)
  Role     Role (foreign key)
  RoleID   uint
  IsActive bool
}

type Role struct {
  ID          uint
  Name        string (unique index)
  Description string
  Permissions []Permission (many-to-many)
}

type Permission struct {
  ID          uint
  Name        string (unique index)
  Resource    string  // 例如: "device", "target", "elasticsearch"
  Action      string  // "create", "read", "update", "delete"
  Description string
}
```

#### 監控實體
```go
type Target struct {
  ID      int
  Subject string
  To      []string (email receivers)
  Enable  bool
  Indices []Index (many-to-many via indices_targets)
}

type Index struct {
  ID          int
  Pattern     string      // ES 索引模式
  DeviceGroup string
  Logname     string
  Period      string      // "minutes", "hours"
  Unit        int
  Field       string      // 用於聚合的欄位
}

type Device struct {
  ID          int
  DeviceGroup string
  Name        string
}

type Receiver struct {
  ID   int
  Name []string (JSON 序列化)
}
```

#### 歷史紀錄與指標實體
```go
type History struct {
  Logname     string
  DeviceGroup string
  Name        string        // 設備名稱
  Status      string        // "online", "offline", "warning", "error"
  Lost        string        // "true"/"false"
  LostNum     int
  Date        string        // YYYY-MM-DD
  Time        string        // HH:MM:SS
  DateTime    string        // YYYY-MM-DD HH:MM:SS
  Timestamp   int64         // Unix 時間戳記
  Period      string
  Unit        int
  ResponseTime int64        // 毫秒
  DataCount   int64
  ErrorMsg    string
  ErrorCode   string
  Metadata    string        // JSON
}

type HistoryArchive struct {
  // 與 History 相同的欄位 (用於封存)
}

type HistoryDailyStats struct {
  Date            string
  Logname         string
  DeviceGroup     string
  TotalChecks     int64
  OnlineCount     int64
  OfflineCount    int64
  WarningCount    int64
  ErrorCount      int64
  UptimeRate      float64
  AvgResponseTime float64
}

type AlertHistory struct {
  Logname     string
  DeviceGroup string
  DeviceName  string
  AlertType   string        // "offline", "error", "warning"
  Severity    string        // "low", "medium", "high", "critical"
  Message     string
  Status      string        // "active", "resolved", "acknowledged"
  ResolvedAt  *int64
  ResolvedBy  string
}
```

#### Elasticsearch 監控實體
```go
type ElasticsearchMonitor struct {
  ID                  int
  Name                string
  Host                string
  Port                int           // 預設: 9200
  Username            string
  Password            string
  EnableAuth          bool
  CheckType           string        // "health,performance"
  Interval            int           // 秒
  EnableMonitor       bool
  Receivers           []string
  Subject             string
  Description         string

  // 警報閾值
  CPUUsageHigh        *float64
  CPUUsageCritical    *float64
  MemoryUsageHigh     *float64
  MemoryUsageCritical *float64
  DiskUsageHigh       *float64
  DiskUsageCritical   *float64
  ResponseTimeHigh    *int64
  ResponseTimeCritical *int64
  UnassignedShardsThreshold *int
  AlertThreshold      string        // JSON 備份
  AlertDedupeWindow   int           // 秒 (預設: 300)
}

type ESMetric struct {
  Time               time.Time
  MonitorID          int
  Status             string        // "online", "offline", "warning", "error"
  ClusterName        string
  ClusterStatus      string        // "green", "yellow", "red"
  ResponseTime       int64         // 毫秒
  CPUUsage           float64       // 百分比
  MemoryUsage        float64       // 百分比
  DiskUsage          float64       // 百分比
  NodeCount          int
  DataNodeCount      int
  QueryLatency       int64
  IndexingRate       float64
  SearchRate         float64
  TotalIndices       int
  TotalDocuments     int64
  TotalSizeBytes     int64
  ActiveShards       int
  RelocatingShards   int
  UnassignedShards   int
  ErrorMessage       string
  WarningMessage     string
  Metadata           string        // JSON
}

type ESAlert struct {
  Time            time.Time
  MonitorID       int
  AlertType       string        // "health", "performance", "capacity"
  Severity        string        // "critical", "high", "medium", "low"
  Message         string
  Status          string        // "active", "resolved", "acknowledged"
  ClusterName     string
  ThresholdValue  *float64
  ActualValue     *float64
  ResolvedAt      *time.Time
  ResolvedBy      string
  ResolutionNote  string
  AcknowledgedAt  *time.Time
  AcknowledgedBy  string
  Metadata        string
}
```

#### 儀表板與統計實體
```go
type HistoryStatistics struct {
  Date            string
  Logname         string
  DeviceGroup     string
  TotalChecks     int64
  OnlineCount     int64
  OfflineCount    int64
  WarningCount    int64
  ErrorCount      int64
  UptimeRate      float64
  AvgResponseTime int64
}

type DashboardData struct {
  TotalTargets   int64
  ActiveTargets  int64
  TotalDevices   int64
  OnlineDevices  int64
  OfflineDevices int64
  UptimeRate     float64
  ActiveAlerts   int64
  LastUpdateTime string
}
```

---

### 2.3 服務層 (業務邏輯 - 22 個服務)

#### 身份驗證服務 (auth.go)
- **HashPassword()**: 使用預設成本的 bcrypt 雜湊
- **CheckPassword()**: 密碼驗證
- **GenerateJWT()**: JWT 權杖生成 (24 小時過期)
- **ValidateJWT()**: 權杖驗證和聲明提取
- **Login()**: 使用者身份驗證
- **Register()**: 使用者註冊,包含權限檢查
- **CreateDefaultRolesAndPermissions()**: 啟動預設 RBAC 結構
- **CreateDefaultAdmin()**: 建立預設管理員使用者
- **CheckPermission()**: 資源權限驗證
- **GetUserByID()**: 使用者檢索

#### 檢測服務 (detect.go)
- **Detect()**: 核心監控功能
  - 在指定時間範圍內查詢 Elasticsearch 的設備
  - 將 ES 結果與資料庫設備清單進行比較
  - 檢測新增/移除/離線設備
  - 生成歷史紀錄
  - 發送電子郵件警報
  - 處理設備自動建立

#### 中央排程器服務 (center.go)
- **LoadCrontab()**: 初始化 cron 排程器
- **ExecuteCrontab()**: 為目標註冊 cron 作業
- **Control_center()**: 在啟動時啟動所有活動目標
- **Control_center_by_TargetID()**: 註冊單一目標
- **Control_center_by_IndiceID()**: 註冊單一索引

#### 歷史紀錄服務 (history.go)
- **CreateHistory()**: 插入監控結果
- **CreateMailHistory()**: 記錄電子郵件發送事件
- **GetHistoryDataByDeviceName()**: 查詢設備歷史
- **GetHistoryDataByDeviceName_TS()**: TimescaleDB 變體
- **GenerateTimeArray()**: 生成用於分析的時間槽

#### 設備服務 (device.go)
- **CreateDevice()**: 批次設備建立
- **UpdateDevice()**: 設備更新
- **DeleteDevice()**: 設備刪除
- **GetDevicesDataByGroupName()**: 按群組取得設備
- **GetDeviceGroup()**: 取得所有設備群組及計數

#### 目標服務 (target.go)
- **GetAllTargets()**: 取得所有目標及其索引
- **CreateTarget()**: 建立監控目標
- **UpdateTarget()**: 更新目標配置
- **DeleteTarget()**: 刪除目標及相關 cron 作業
- **GetTargetByID()**: 檢索單一目標

#### 索引服務 (indices.go)
- **CreateIndices()**: 建立 ES 索引配置
- **UpdateIndices()**: 更新索引對應
- **DeleteIndices()**: 刪除索引配置
- **GetIndicesDataByLogname()**: 按日誌名稱尋找索引
- **GetAllIndices()**: 列出所有索引

#### 接收者服務 (receiver.go)
- **GetAllReceivers()**: 取得所有接收者
- **CreateReceiver()**: 建立電子郵件接收者
- **UpdateReceiver()**: 更新接收者
- **DeleteReceiver()**: 刪除接收者

#### 郵件服務 (mail.go)
- **Mail4()**: 發送帶有表格格式的 HTML 電子郵件
- **支援**: SMTP 認證、自訂範本
- **配置**: Gmail SMTP、自訂主機/埠

#### Elasticsearch 監控服務 (es_monitor_service.go)
- **CreateESMonitor()**: 建立 ES 健康監控器
- **UpdateESMonitor()**: 更新監控器配置
- **GetAllESMonitors()**: 列出所有監控器
- **GetESMonitorByID()**: 取得監控器詳情
- **DeleteESMonitor()**: 刪除監控器

#### ES 排程器服務 (es_scheduler.go)
- **InitESScheduler()**: 初始化單例排程器
- **LoadAllMonitors()**: 在啟動時載入已啟用的監控器
- **StartMonitor()**: 啟動定期健康檢查
- **RestartMonitor()**: 使用新配置重新啟動
- **StopMonitor()**: 停止監控

#### Elasticsearch 查詢服務 (es_query.go)
- **SearchRequest()**: 執行 ES DSL 查詢
  - 在指定欄位上進行聚合
  - 使用 @timestamp 進行日期範圍篩選
  - 支援複雜篩選

#### ES 插入服務 (es_insert.go)
- 將資料插入 Elasticsearch 索引

#### 批次寫入器服務 (batch_writer.go)
- **NewBatchWriter()**: 初始化批次寫入器,可配置大小/間隔
- **AddHistory()**: 將紀錄新增到批次佇列
- **flushDeviceMetrics()**: 批次插入到 TimescaleDB device_metrics
- **flushESMetrics()**: 批次插入到 TimescaleDB es_metrics
- **flushBatch()**: 由定時器觸發的定期刷新
- **Stop()**: 優雅關閉,進行最終刷新

**功能**:
- 支援多種歷史類型 (設備/ES 指標)
- 可配置批次大小 (預設: 50)
- 可配置刷新間隔 (預設: 5 秒)
- 事務支援以確保資料一致性
- 預備語句以提高效能

#### 設定服務 (setting.go)
- 從 setting.yml 載入 YAML 配置
- 從 YAML 解析目標和接收者

#### SQL 表格服務 (sqltable.go)
- **CreateTable()**: 使用 GORM AutoMigrate 進行資料庫結構遷移
- 建立表格:Users、Roles、Permissions、Devices、Receivers、Indices、Targets、History、Archives、Stats、MailHistory、AlertHistory、CronList、ESMonitor

#### 工具服務 (tools.go)
- **ListCompare()**: 比較設備清單 (新增/移除/交集)

#### 儀表板服務
- **GetDashboardData()**: 聚合系統統計資料
- **GetHistoryStatistics()**: 歷史資料聚合
- **GetTrendData()**: 隨時間的趨勢分析
- **GetGroupStatistics()**: 設備群組統計
- **GetDeviceStatusOverview()**: 設備狀態摘要
- **GetDeviceTimeline()**: 設備狀態時間軸視覺化
- **GetRecentAlerts()**: 最近的警報清單
- **CreateAlert()**: 建立警報紀錄
- **UpdateAlertStatus()**: 更新警報狀態

---

### 2.4 控制器層 (HTTP 處理器)

#### 身份驗證控制器 (auth.go)
- `POST /auth/login` - 使用者登入
- `POST /api/v1/auth/register` - 註冊新使用者
- `GET /api/v1/auth/profile` - 取得使用者個人資料
- `POST /api/v1/auth/refresh` - 刷新 JWT 權杖
- `GET /api/v1/auth/users` - 列出使用者
- `GET /api/v1/auth/users/:id` - 按 ID 取得使用者
- `PUT /api/v1/auth/users/:id` - 更新使用者
- `DELETE /api/v1/auth/users/:id` - 刪除使用者

#### 目標控制器 (target.go)
- `GET /api/v1/Target/GetAll` - 列出所有目標
- `POST /api/v1/Target/Create` - 建立目標
- `PUT /api/v1/Target/Update` - 更新目標
- `DELETE /api/v1/Target/Delete/:id` - 刪除目標

#### 設備控制器 (device.go)
- `GET /api/v1/Device/GetAll` - 列出設備
- `POST /api/v1/Device/Create` - 建立設備
- `PUT /api/v1/Device/Update` - 更新設備
- `DELETE /api/v1/Device/Delete/:id` - 刪除設備
- `GET /api/v1/Device/count` - 按群組取得設備計數
- `GET /api/v1/Device/GetGroup` - 取得設備群組

#### 索引控制器 (indices.go)
- `GET /api/v1/Indices/GetAll` - 列出索引
- `POST /api/v1/Indices/Create` - 建立索引
- `PUT /api/v1/Indices/Update` - 更新索引
- `DELETE /api/v1/Indices/Delete/:id` - 刪除索引
- `GET /api/v1/Indices/GetLogname` - 取得日誌名稱
- `GET /api/v1/Indices/GetIndicesByLogname/:logname` - 按日誌名稱取得
- `GET /api/v1/Indices/GetIndicesByTargetID/:id` - 按目標取得

#### 接收者控制器 (receiver.go)
- `GET /api/v1/Receiver/GetAll` - 列出接收者
- `POST /api/v1/Receiver/Create` - 建立接收者
- `PUT /api/v1/Receiver/Update` - 更新接收者
- `DELETE /api/v1/Receiver/Delete/:id` - 刪除接收者

#### 歷史紀錄控制器 (history.go)
- `GET /api/v1/History/GetData/:logname` - 按日誌名稱取得歷史紀錄
- `GET /api/v1/History/GetLognameData` - 取得所有日誌名稱資料

#### 儀表板控制器 (dashboard.go)
- `GET /api/v1/dashboard/overview` - 系統概覽
- `GET /api/v1/dashboard/statistics` - 歷史統計
- `GET /api/v1/dashboard/trends` - 趨勢資料
- `GET /api/v1/dashboard/groups/statistics` - 群組統計
- `GET /api/v1/dashboard/devices/status` - 設備狀態概覽
- `GET /api/v1/dashboard/devices/:device_name/timeline` - 設備時間軸
- `GET /api/v1/dashboard/alerts/recent` - 最近的警報
- `POST /api/v1/dashboard/alerts` - 建立警報
- `PUT /api/v1/dashboard/alerts/:id/status` - 更新警報狀態

#### Elasticsearch 控制器 (elasticsearch.go)
- `GET /api/v1/elasticsearch/monitors` - 列出監控器
- `GET /api/v1/elasticsearch/monitors/:id` - 按 ID 取得監控器
- `POST /api/v1/elasticsearch/monitors` - 建立監控器
- `PUT /api/v1/elasticsearch/monitors` - 更新監控器
- `DELETE /api/v1/elasticsearch/monitors/:id` - 刪除監控器
- `POST /api/v1/elasticsearch/monitors/:id/test` - 測試連線
- `POST /api/v1/elasticsearch/monitors/:id/toggle` - 啟用/停用監控器
- `GET /api/v1/elasticsearch/status` - 取得所有監控器狀態
- `GET /api/v1/elasticsearch/status/:id/history` - 監控器歷史
- `GET /api/v1/elasticsearch/statistics` - ES 統計
- `GET /api/v1/elasticsearch/alerts` - 列出警報
- `GET /api/v1/elasticsearch/alerts/:monitor_id` - 按 ID 取得警報
- `POST /api/v1/elasticsearch/alerts/:monitor_id/resolve` - 解決警報
- `PUT /api/v1/elasticsearch/alerts/:monitor_id/acknowledge` - 確認警報

#### 設定控制器 (setting.go)
- `GET /api/v1/get-sso-url` - 取得 SSO 配置
- `GET /api/v1/user/get-server-menu` - 取得選單結構
- `GET /api/v1/get-server-module` - 取得可用模組

---

### 2.5 路由配置

**路由群組與中介軟體鏈**:

1. **公開路由** (無需驗證)
   - `GET /healthcheck` - 健康檢查端點
   - `POST /auth/login` - 公開登入

2. **受保護的 API 路由** (/api/v1)
   - 應用的中介軟體:
     - `OptionalAuthMiddleware()` - 向後相容
     - `AuthMiddleware()` - 在受保護的資源上
     - `PermissionMiddleware(resource, action)` - RBAC 強制執行

3. **基於資源的路由群組**:
   - `/Receiver` - 電子郵件接收者 (權限: target.*)
   - `/Target` - 監控目標 (權限: target.*)
   - `/Device` - 受管理設備 (權限: device.*)
   - `/Indices` - ES 索引 (權限: indices.*)
   - `/History` - 監控歷史 (公開讀取)
   - `/dashboard` - 視覺化端點
   - `/elasticsearch` - ES 監控 (權限: elasticsearch.*)
   - `/admin/data` - 資料管理 (僅限管理員)

---

### 2.6 中介軟體 (安全性與授權)

#### 身份驗證中介軟體 (middleware/auth.go)
- **AuthMiddleware()**: 驗證 JWT 權杖
  - 需要「Bearer {token}」格式
  - 設定使用者上下文 (user_id、username、role_id)
  - 無效/缺少權杖時回傳 401

- **OptionalAuthMiddleware()**: 可選身份驗證
  - 如果存在則驗證權杖
  - 缺少權杖時不中止
  - 啟用向後相容性

- **PermissionMiddleware(resource, action)**: RBAC 強制執行
  - 檢查使用者是否具有資源操作的權限
  - 如果權限不足則回傳 403

- **RequireRole(...roles)**: 基於角色的存取控制
  - 接受多個允許的角色
  - 用於管理員/特殊路由

- **AdminOnly()**: 僅限管理員路由的便利方法
  - RequireRole("admin") 的簡寫

- **GetCurrentUser()**: 從上下文檢索使用者
  - 從資料庫取得完整使用者物件
  - 在處理器中用於使用者特定邏輯

---

### 2.7 全域配置與狀態

```go
type GlobalState {
  EnvConfig      *EnviromentModel  // 從 config.yml 載入
  Elasticsearch  *elasticsearch.Client
  TargetStruct   *TargetStruct     // 從 setting.yml
  Mysql          *gorm.DB          // MySQL 連線
  Crontab        *cron.Cron        // 排程器實例
  TimescaleDB    *sql.DB           // TimescaleDB 連線
  BatchWriter    BatchWriterType   // 批次插入服務
}
```

---

## 3. 關鍵功能與特性

### 3.1 核心監控工作流程

1. **配置載入** (main.go)
   - 載入環境配置 (config.yml)
   - 載入監控目標 (setting.yml)
   - 初始化資料庫連線
   - 建立資料庫結構

2. **排程器初始化** (center.go)
   - 為每個目標/索引對註冊 Cron 作業
   - Cron 表達式: 分鐘: `*/{unit} * * * *`, 小時: `0 */{unit} * * *`
   - 將 Entry ID 儲存在 CronList 表格中以便管理

3. **定期檢測** (detect.go)
   - 按排程執行
   - 在時間範圍內查詢 Elasticsearch 的設備
   - 與設備資料庫進行比較
   - 檢測新增/離線設備
   - 將結果儲存在 History 表格中
   - 為缺失的設備生成警報

4. **警報生成與傳送**
   - 透過 SMTP 發送電子郵件通知
   - HTML 格式的表格,包含離線設備清單
   - 接收者清單來自 Target 配置

### 3.2 Elasticsearch 監控

**獨立監控系統**:

1. **監控器配置** (ElasticsearchMonitor 實體)
   - 獨立排程器 (ESMonitorScheduler)
   - 可配置的檢查間隔 (10-3600 秒)
   - 多種檢查類型: health、performance、capacity、availability

2. **健康檢查** (ESMonitorService)
   - 叢集健康狀態 (green/yellow/red)
   - CPU/記憶體/磁碟使用率
   - 節點數量和分片分佈
   - 查詢/索引延遲
   - 回應時間追蹤

3. **警報閾值**
   - CPU: 高 (75%)、嚴重 (85%)
   - 記憶體: 高 (80%)、嚴重 (90%)
   - 磁碟: 高 (85%)、嚴重 (95%)
   - 回應時間: 高 (3000 毫秒)、嚴重 (10000 毫秒)
   - 未分配分片: 1+

4. **資料儲存**
   - 指標: TimescaleDB (es_metrics 表格)
   - 警報: TimescaleDB (alert_history 表格)
   - 配置: MySQL (elasticsearch_monitors 表格)

5. **警報管理**
   - 狀態: active、resolved、acknowledged
   - 去重視窗 (預設: 5 分鐘)
   - 解決追蹤

### 3.3 使用者身份驗證與授權

**多層級 RBAC**:

```
User
  └─ Role (1-to-1)
      └─ Permissions (many-to-many)
```

**權限結構**:
```
Resource: device, target, receiver, indices, elasticsearch, user
Action: create, read, update, delete
Name: {resource}.{action}
```

**預設角色**:
- admin: 完整權限
- user: 所有資源的讀取存取
- operator: 在分配的資源上建立/更新權限

### 3.4 資料管線

**MySQL → History → TimescaleDB 批次管線**:

1. **寫入路徑**:
   - Detect() 生成 History 紀錄
   - BatchWriter 在記憶體中累積紀錄
   - 刷新條件: 批次已滿 (50 項) 或定時器 (5 秒)
   - 透過預備語句插入 TimescaleDB
   - 以事務包裝以確保一致性

2. **TimescaleDB 表格**:
   - `device_metrics`: 設備監控資料 (超表格)
   - `es_metrics`: Elasticsearch 指標 (超表格)
   - `alert_history`: 警報紀錄

3. **查詢路徑**:
   - 從 MySQL 查詢 History 以取得即時資料
   - TimescaleDB 用於歷史/聚合資料
   - 儀表板服務跨兩個來源進行聚合

### 3.5 資料封存與聚合

**歷史紀錄管理** (dashboard.go):
- **CleanOldHistory()**: 刪除超過閾值的歷史紀錄
- **ArchiveOldHistory()**: 移至 history_archive 表格
- **CreateDailyAggregates()**: 生成 HistoryDailyStats
- **GetStorageStats()**: 儲存空間使用監控

---

## 4. 資料庫結構

### MySQL 表格

| 表格 | 目的 | 關鍵欄位 |
|-------|---------|-----------|
| users | 使用者帳戶 | id, username (unique), email (unique), password, role_id, is_active |
| roles | 使用者角色 | id, name (unique), description |
| permissions | 系統權限 | id, name (unique), resource, action |
| role_permissions | RBAC 對應 | role_id, permission_id |
| devices | 受監控設備 | id, device_group, name |
| targets | 監控目標 | id, subject, to (JSON), enable |
| indices | ES 索引配置 | id, pattern, device_group, logname, period, unit, field |
| indices_targets | 目標-索引對應 | target_id, index_id |
| receivers | 電子郵件接收者 | id, name (JSON) |
| history | 監控結果 | id, logname, device_group, name, status, lost, date, time, response_time, data_count, metadata (JSON) |
| history_archive | 封存歷史紀錄 | 與 history 相同 |
| history_daily_stats | 每日聚合 | date, logname, device_group, total_checks, online_count, uptime_rate, avg_response_time |
| mail_history | 電子郵件日誌 | id, date, time, logname, sended |
| alert_history | 警報紀錄 | id, logname, device_group, device_name, alert_type, severity, status, resolved_at, resolved_by |
| cron_lists | 排程器對應 | entry_id, target_id, index_id |
| elasticsearch_monitors | ES 監控器配置 | id, name, host, port, check_type, interval, enable_monitor, threshold fields, alert_threshold (JSON) |

### TimescaleDB 表格

| 表格 | 目的 | 關鍵欄位 |
|-------|---------|-----------|
| device_metrics | 設備監控 (超表格) | time (分區), device_id, device_group, logname, status, lost, response_time, data_count, error_msg |
| es_metrics | ES 指標 (超表格) | time (分區), monitor_id, cpu_usage, memory_usage, disk_usage, node_count, active_shards, unassigned_shards |
| alert_history | 警報紀錄 | time, monitor_id, alert_type, severity, status |

---

## 5. API 端點與路由

### 身份驗證端點
```
POST    /auth/login                         # 登入
POST    /api/v1/auth/register              # 註冊使用者
GET     /api/v1/auth/profile               # 取得個人資料
POST    /api/v1/auth/refresh               # 刷新權杖
GET     /api/v1/auth/users                 # 列出使用者
GET     /api/v1/auth/users/:id             # 取得使用者
PUT     /api/v1/auth/users/:id             # 更新使用者
DELETE  /api/v1/auth/users/:id             # 刪除使用者
```

### 目標管理
```
GET     /api/v1/Target/GetAll              # 列出目標
POST    /api/v1/Target/Create              # 建立目標
PUT     /api/v1/Target/Update              # 更新目標
DELETE  /api/v1/Target/Delete/:id          # 刪除目標
```

### 設備管理
```
GET     /api/v1/Device/GetAll              # 列出設備
POST    /api/v1/Device/Create              # 建立設備
PUT     /api/v1/Device/Update              # 更新設備
DELETE  /api/v1/Device/Delete/:id          # 刪除設備
GET     /api/v1/Device/count               # 按群組計數
GET     /api/v1/Device/GetGroup            # 列出群組
```

### 索引管理
```
GET     /api/v1/Indices/GetAll             # 列出索引
POST    /api/v1/Indices/Create             # 建立索引
PUT     /api/v1/Indices/Update             # 更新索引
DELETE  /api/v1/Indices/Delete/:id         # 刪除索引
GET     /api/v1/Indices/GetLogname         # 取得日誌名稱
GET     /api/v1/Indices/GetIndicesByLogname/:logname  # 按日誌名稱
GET     /api/v1/Indices/GetIndicesByTargetID/:id      # 按目標
```

### 接收者管理
```
GET     /api/v1/Receiver/GetAll            # 列出接收者
POST    /api/v1/Receiver/Create            # 建立接收者
PUT     /api/v1/Receiver/Update            # 更新接收者
DELETE  /api/v1/Receiver/Delete/:id        # 刪除接收者
```

### 歷史紀錄與監控
```
GET     /api/v1/History/GetData/:logname   # 按日誌名稱取得
GET     /api/v1/History/GetLognameData     # 取得所有資料
```

### 儀表板與視覺化
```
GET     /api/v1/dashboard/overview         # 系統概覽
GET     /api/v1/dashboard/statistics       # 統計資料
GET     /api/v1/dashboard/trends           # 趨勢
GET     /api/v1/dashboard/groups/statistics # 群組統計
GET     /api/v1/dashboard/devices/status   # 設備狀態
GET     /api/v1/dashboard/devices/:device_name/timeline # 時間軸
GET     /api/v1/dashboard/alerts/recent    # 最近的警報
POST    /api/v1/dashboard/alerts           # 建立警報
PUT     /api/v1/dashboard/alerts/:id/status # 更新警報
```

### Elasticsearch 監控
```
GET     /api/v1/elasticsearch/monitors     # 列出監控器
GET     /api/v1/elasticsearch/monitors/:id # 取得監控器
POST    /api/v1/elasticsearch/monitors     # 建立監控器
PUT     /api/v1/elasticsearch/monitors     # 更新監控器
DELETE  /api/v1/elasticsearch/monitors/:id # 刪除監控器
POST    /api/v1/elasticsearch/monitors/:id/test      # 測試連線
POST    /api/v1/elasticsearch/monitors/:id/toggle    # 啟用/停用
GET     /api/v1/elasticsearch/status       # 所有狀態
GET     /api/v1/elasticsearch/status/:id/history     # 監控器歷史
GET     /api/v1/elasticsearch/statistics   # 統計資料
GET     /api/v1/elasticsearch/alerts       # 列出警報
GET     /api/v1/elasticsearch/alerts/:monitor_id     # 取得警報
POST    /api/v1/elasticsearch/alerts/:monitor_id/resolve      # 解決
PUT     /api/v1/elasticsearch/alerts/:monitor_id/acknowledge  # 確認
```

### 管理員資料管理
```
DELETE  /api/v1/admin/data/clean-history          # 清理舊歷史紀錄
POST    /api/v1/admin/data/archive-history        # 封存歷史紀錄
POST    /api/v1/admin/data/create-aggregates      # 建立聚合
GET     /api/v1/admin/data/storage-stats          # 儲存空間統計
```

### 配置
```
GET     /api/v1/get-sso-url                # SSO 配置
GET     /api/v1/user/get-server-menu       # 選單結構
GET     /api/v1/get-server-module          # 模組
GET     /healthcheck                       # 健康檢查
```

---

## 6. 身份驗證與授權

### JWT 身份驗證流程

1. **登入** (POST /auth/login)
   ```
   請求: { username, password }
   回應: { token, user }
   權杖: HS256 簽署, 24 小時過期
   聲明: user_id, username, role_id, exp, iat
   ```

2. **權杖驗證** (AuthMiddleware)
   ```
   標頭: Authorization: Bearer {token}
   驗證: 簽章、過期時間、格式
   設定上下文: user_id, username, role_id
   ```

3. **權限檢查** (PermissionMiddleware)
   ```
   驗證: 使用者具有 resource.action 權限
   回傳: 如果權限不足則為 403 Forbidden
   ```

### RBAC 實作

```
User → Role → Permissions (many-to-many)
       ↓
   在登入時載入

中介軟體檢查:
1. 使用者已驗證 (有效的 JWT)
2. 使用者啟用
3. 使用者具有所需的角色/權限
```

### JWT 配置

- **密鑰**: 來自環境變數 JWT_SECRET
- **預設**: "your-secret-key-change-in-production"
- **過期時間**: 24 小時
- **演算法**: HS256 (HMAC-SHA256)
- **雜湊函數**: 密碼使用 bcrypt

---

## 7. 外部整合

### 7.1 Elasticsearch 整合

**查詢能力**:
- DSL 查詢建構
- 在可配置欄位上進行聚合
- 使用 @timestamp 進行日期範圍篩選
- 支援複雜的布林查詢

**監控**:
- 叢集健康狀態
- 節點和分片資訊
- 索引統計
- 效能指標

**查詢範例**:
```json
{
  "aggs": {
    "2": {
      "terms": {
        "field": "host.keyword",
        "size": 100
      }
    }
  },
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "@timestamp": {
              "gte": "2024-01-01T00:00",
              "lte": "2024-01-01T23:59"
            }
          }
        }
      ]
    }
  }
}
```

### 7.2 電子郵件整合

**SMTP 配置**:
- 提供者: Gmail (可配置)
- 主機: smtp.gmail.com (可配置)
- 埠: 587 (可配置)
- 驗證: 使用者名稱/密碼
- TLS: 支援

**電子郵件功能**:
- HTML 範本
- 結果的表格格式
- 多個收件者
- 主旨自訂

**從 config.yml**:
```yaml
email:
  user: "rabot6201@gmail.com"
  password: "fuhbrbezkwpcuzsv"
  sender: "rabot6201@gmail.com"
  host: "smtp.gmail.com"
  port: "587"
  auth: true
```

### 7.3 SSO 整合 (Keycloak)

**配置** (config.yml):
```yaml
sso:
  url: "https://10.99.1.133:8443"
  realm: "master"
  username: "admin"
  password: "1qaz2wsx"
  client_id: "log-detect"
  admin_role: "log-detect-admin"
  user_role: "log-detect-op"
```

**目的**: 外部身份提供者整合 (程式碼中未完全實作)

---

## 8. 業務邏輯與核心功能

### 8.1 設備發現與管理

**自動發現** (detect.go):
1. 在配置的模式/欄位中查詢 ES 的設備
2. 如果群組的資料庫中沒有設備: 建立所有 ES 設備
3. 如果設備存在: 將 ES 結果與資料庫進行比較
4. **新增**的設備: 建立並插入資料庫
5. **移除**的設備: 生成警報
6. **重複**: 合併和清理

**設備群組**:
- 受監控設備的邏輯分組
- 用於監控查詢
- 在 Device 實體中追蹤

### 8.2 目標與索引管理

**目標**:
- 監控配置容器
- 包含電子郵件接收者
- 可以啟用/停用
- 每個目標多個索引

**索引**:
- ES 索引模式定義
- 聚合欄位規範
- 監控排程 (period/unit)
- 透過多對多連結到目標

**工作流程**:
1. 建立索引 (ES 模式)
2. 建立目標 (接收者群組)
3. 連結索引 → 目標
4. 系統生成 cron 作業
5. Detect() 按排程執行

### 8.3 Cron 作業管理

**註冊** (center.go):
```
對於每個具有索引的目標:
  對於每個索引:
    生成 cron 表達式
    使用 robfig/cron/v3 註冊
    將 EntryID 儲存在 CronList 中
```

**Cron 表達式**:
- 分鐘: `*/{unit} * * * *`
- 小時: `0 */{unit} * * *`

**生命週期**:
- 建立: 在目標建立時
- 更新: 移除舊的 → 建立新的
- 刪除: 從 cron + CronList 移除
- 重新啟動: 在系統啟動時完全重建

### 8.4 警報生成

**觸發事件**:
1. 設備離線 (ES 結果中缺失)
2. ES 監控器閾值超過
3. Elasticsearch 叢集問題

**警報屬性**:
- 類型: offline、error、warning、health、performance
- 嚴重性: low、medium、high、critical
- 狀態: active、resolved、acknowledged
- 時間戳記: 檢測時間
- 設備/監控器資訊: 受影響的資源

**傳送**:
- 傳送電子郵件給配置的接收者
- HTML 格式
- 表格格式的設備清單

### 8.5 時序資料管理

**批次寫入** (batch_writer.go):
```
新增紀錄 → 記憶體緩衝區 → 刷新決策
                                    ↓
                          大小 (≥50) 或時間 (5秒)
                                    ↓
                          批次插入到 TimescaleDB
                                    ↓
                          事務 + 預備語句
```

**優點**:
- 減少寫入開銷
- 更好的網路利用率
- 事務支援
- 預備語句保護

**配置** (config.yml):
```yaml
batch_writer:
  enabled: true
  batch_size: 50
  flush_interval: "5s"
```

### 8.6 儀表板與分析

**概覽**:
- 總目標/設備數
- 線上/離線計數
- 全系統正常運行率
- 活動警報計數

**統計資料**:
- 按日誌名稱分解
- 按設備群組分解
- 時序資料點

**趨勢**:
- 隨時間的正常運行百分比
- 離線設備計數趨勢
- 錯誤計數趨勢
- 回應時間趨勢

**設備時間軸**:
- 每次檢查時的狀態
- 每次檢查的回應時間
- 每次檢查的資料計數
- 錯誤詳情

---

## 9. 配置檔案

### config.yml (主配置)

```yaml
database:
  client: "mysql"
  host: "10.99.1.133"
  port: "3306"
  user: "runner"
  password: "1qaz2wsx"
  name: "logdetect"
  max_idle: 10
  max_open_conn: 100
  max_life_time: "1h"

timescale:
  host: "10.99.1.213"
  port: "5432"
  user: "logdetect"
  password: "your_secure_password"
  name: "monitoring"
  max_idle: 10
  max_open_conn: 100

batch_writer:
  enabled: true
  batch_size: 50
  flush_interval: "5s"

server:
  port: ":8006"
  mode: "debug"

es:
  url: "https://10.99.1.213:9200"
  sourceAccount: "elastic"
  sourcePassword: "a12345678"

email:
  user: "rabot6201@gmail.com"
  password: "fuhbrbezkwpcuzsv"
  sender: "rabot6201@gmail.com"
  host: "smtp.gmail.com"
  port: "587"
  auth: true

sso:
  url: "https://10.99.1.133:8443"
  realm: "master"
  client_id: "log-detect"
```

### setting.yml (監控配置)

```yaml
targets:
  - receiver:
      - "russell.chen@bimap.co"
      - "rabot6201@gmail.com"
    subject: "log-detect test01"
    indices:
      - index: "logstash-log_detect*"
        logname: "waf"
        period: "minutes"
        unit: 60
        field: "host.keyword"
```

---

## 10. 工具與輔助函數

### CORS 配置 (utils/cors.go)
```go
AllowOrigins: []string{"http://localhost:4200"}
AllowMethods: ["PUT", "POST", "GET", "DELETE"]
AllowHeaders: ["Content-Type", "Authorization", "realm"]
AllowCredentials: true
```

### 錯誤日誌記錄 (handler/error.go)
- 寫入按月輪換的日誌檔案
- 格式: `apiError-{YYYYMM}.log`
- 記錄: 方法、URL、錯誤訊息

### 工具與輔助程式 (services/tools.go)
- **ListCompare()**: 檢測清單之間的新增/移除項目

---

## 11. 初始化與啟動流程

**main.go 啟動序列**:

```
1. LoadEnvironment()           # 解析 config.yml
   ↓
2. LoadDatabase()              # MySQL 連線
   ↓
3. LoadTimescaleDB()           # PostgreSQL 連線
   ↓
4. Initialize BatchWriter      # 批次插入服務
   (如果在配置中啟用)
   ↓
5. SetElkClient()              # Elasticsearch 連線
   ↓
6. CreateTable()               # 資料庫遷移
   ↓
7. InitAuthService()           # RBAC 初始化
   - CreateDefaultRolesAndPermissions()
   - CreateDefaultAdmin()
   ↓
8. LoadCrontab()               # 排程器初始化
   ↓
9. InitESScheduler()           # ES 監控器排程器
   - LoadAllMonitors()         # 從資料庫載入
   ↓
10. Control_center()            # 啟動所有目標
    - 註冊所有 cron 作業
    ↓
11. LoadRouter()                # HTTP 路由
    ↓
12. Listen(:8006)               # 啟動伺服器
```

---

## 12. 關鍵設計模式

### 單例模式
- GlobalESScheduler (ES 監控)
- 全域資料庫連線

### 工廠模式
- NewAuthService()、NewBatchWriter()

### 中介軟體鏈
- AuthMiddleware → PermissionMiddleware

### 儲存庫模式 (部分)
- 服務函數充當業務邏輯
- 服務中的直接 GORM 查詢

### 批次處理模式
- BatchWriter 累積並定期刷新

### 排程器模式
- Robfig Cron 用於檢測排程
- 基於時間的計時器用於批次刷新

---

## 13. 依賴項與匯入

### 外部函式庫
```go
github.com/gin-gonic/gin              # Web 框架
github.com/gin-contrib/cors           # CORS 中介軟體
gorm.io/gorm                          # ORM
gorm.io/driver/mysql                  # MySQL 驅動程式
github.com/elastic/go-elasticsearch/v8 # ES 客戶端
github.com/lib/pq                     # PostgreSQL 驅動程式
github.com/golang-jwt/jwt/v5          # JWT
golang.org/x/crypto/bcrypt            # 密碼雜湊
github.com/robfig/cron/v3             # Cron 排程器
github.com/spf13/viper                # 配置管理
github.com/swaggo/gin-swagger         # Swagger UI
github.com/natefinch/lumberjack       # 日誌輪換
```

---

## 14. 安全性考量

### 優勢
- 基於 JWT 的身份驗證
- bcrypt 密碼雜湊
- 具有權限檢查的 RBAC
- Elasticsearch 的 SSL/TLS
- 參數化查詢 (GORM + 預備語句)

### 改進領域
- JWT 密鑰不應使用硬編碼的預設值
- ES 的 SSL 驗證已停用 (InsecureSkipVerify)
- 配置檔案中的電子郵件憑證
- 無速率限制
- 無輸入驗證中介軟體
- 無請求簽署

---

## 15. 可擴展性與效能

### 目前的最佳化
- 連線池 (MySQL、TimescaleDB)
- 批次插入以減少 I/O
- ES 查詢的預備語句
- 可配置的批次大小和刷新間隔
- 用於指標的時序資料庫
- 用於擴展性的 JSON 後設資料欄位

### 潛在瓶頸
- 單一 Cron 實例 (排程器)
- 同步電子郵件發送
- 基於記憶體的批次處理 (非持久性)
- 無快取層
- 無查詢最佳化提示

---

## 16. 合規性與治理

### 資料管理
- 舊紀錄的歷史封存
- 每日統計聚合
- 可配置的保留政策
- 警報歷史追蹤

### 稽核軌跡
- 郵件歷史記錄
- 用於作業追蹤的 CronList
- 透過角色/權限進行使用者稽核
- 警報解決追蹤

---

## 結論

Log Detect Backend 是一個全面的監控系統,具有:
- **多資料庫架構**: MySQL + TimescaleDB + Elasticsearch
- **精密排程**: 基於 Cron 的檢測 + ES 監控器排程器
- **完整的 RBAC**: 使用者/角色/權限模型
- **豐富的分析**: 儀表板、統計資料、趨勢
- **電子郵件警報**: HTML 格式的通知
- **可擴展設計**: JSON 後設資料、可插拔檢查器

該程式碼庫遵循分層架構 (controllers → services → entities → clients),具有良好的關注點分離。批次寫入系統實現了高效的時序資料儲存,而排程器管理複雜的監控工作流程。

